<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Text </title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Lucide Icons (ç”¨æ–¼ç¾è§€åœ–æ¨™) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@100..900&display=swap');
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        .sample-content {
            white-space: pre-wrap; /* ä¿ç•™æ›è¡Œå’Œç©ºæ ¼ */
        }
        /* Custom modal for alerts/prompts */
        .custom-modal {
            transition: opacity 0.3s ease-in-out;
        }
        .lucide {
            width: 1.25rem;
            height: 1.25rem;
        }
        /* æ¨¡æ…‹æ¡†å‹•ç•« */
        .modal-content-transition {
            transition: transform 0.3s ease-out;
        }
    </style>
    <!-- Firebase & Gemini API Imports and Logic -->
    <script type="module">
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-analytics.js";

        
        
        // --- 1. è¨­å®šæª”èˆ‡åˆå§‹åŒ– ---
        const firebaseConfig = {{ apiKey: "AIzaSyBnQmqGZQ_94BDgmZFzOJsKDjgYq8ipI2I", authDomain: "hkttext.firebaseapp.com", projectId: "hkttext", storageBucket: "hkttext.firebasestorage.app", messagingSenderId: "501339425536", appId: "1:501339425536:web:f9ddbf080a002be99701e5", measurementId: "G-CKY8VPMJXJ" }};
        let app, db, auth, analytics, userId = null, samples = [], currentCategoryFilter = 'å…¨éƒ¨', activeEditId = null;
        const appId = 'default-app-id';
        try {{ app = initializeApp(firebaseConfig); analytics = getAnalytics(app); auth = getAuth(app); db = getFirestore(app); }} catch (e) {{ console.error("Firebase Init Error", e); }}


        // åˆå§‹åŒ– Firebase æœå‹™
        if (envFirebaseConfig) { // ç¾åœ¨ envFirebaseConfig æ˜¯ç¶“éå®‰å…¨è§£æçš„ç‰©ä»¶ï¼Œæˆ–ç‚º null
            try {
                app = initializeApp(envFirebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (error) {
                // ç¢ºä¿åœ¨åˆå§‹åŒ–å¤±æ•—æ™‚ï¼ŒéŒ¯èª¤è¨Šæ¯èƒ½é¡¯ç¤º
                console.error("Firebase åˆå§‹åŒ–å¤±æ•— (initializeApp failed):", error);
                document.getElementById('app-container').innerHTML = `
                    <div class="p-6 bg-red-100 border border-red-400 text-red-700 rounded-lg max-w-lg mx-auto mt-10">
                        <p class="font-bold">è¨­å®šéŒ¯èª¤</p>
                        <p>Firebase åˆå§‹åŒ–å¤±æ•—ã€‚é€™å¯èƒ½æ˜¯å› ç‚º API é‡‘é‘°æˆ– Project ID ç„¡æ•ˆã€‚</p>
                        <p class="text-xs mt-2">éŒ¯èª¤è¨Šæ¯: ${error.message}</p>
                    </div>
                `;
            }
        } else {
            console.error("Firebase configuration (__firebase_config) is missing, empty, or failed to parse. Data persistence will not work.");
            document.getElementById('app-container').innerHTML = `
                <div class="p-6 bg-red-100 border border-red-400 text-red-700 rounded-lg max-w-lg mx-auto mt-10">
                    <p class="font-bold">è¨­å®šéŒ¯èª¤</p>
                    <p>ç„¡æ³•è¼‰å…¥ Firebase é…ç½®ã€‚ç’°å¢ƒè®Šæ•¸éºå¤±æˆ–è§£æå¤±æ•—ã€‚</p>
                </div>
            `;
        }
        
        // --- 3. èªè­‰èˆ‡ä½¿ç”¨è€…è¨­å®š (é—œéµä¿®æ”¹) ---
        const signInAndListen = async () => {{ if (!auth) return; onAuthStateChanged(auth, (user) => {{ if (user) {{ userId = user.uid; renderUI(); listenForSamples(); }} else {{ signInAnonymously(auth); }} }}); }};// --- 4. Firestore è³‡æ–™æ“ä½œ (ä¿æŒä¸è®Š) ---

        const getSamplesCollectionRef = () => {
            if (!userId || !db) {
                console.error("User ID or Firestore service is not set. Cannot get collection reference.");
                // ğŸš¨ å¦‚æœç¼ºå°‘ userIdï¼Œè¿”å› nullï¼ŒlistenForSamples å°‡æœƒé€€å‡º
                return null;
            }
            return collection(db, `artifacts/${appId}/users/${userId}/text_samples`);
        };

        const listenForSamples = () => {
            const colRef = getSamplesCollectionRef();
            if (!colRef) return; // å¦‚æœæ²’æœ‰ refï¼Œå‰‡é€€å‡º

            const q = query(colRef);
            
            onSnapshot(q, (snapshot) => {
                samples = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                samples.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                
                renderUI(); // æ•¸æ“šè¼‰å…¥å®Œæˆå¾Œå†æ¬¡æ¸²æŸ“ï¼Œé¡¯ç¤ºæ¨£æœ¬å’Œæ­£ç¢ºçš„è¨ˆæ•¸
            }, (error) => {
                console.error("Error listening to Firestore:", error);
                // å³ä½¿ç›£è½å¤±æ•—ï¼Œä¹Ÿå˜—è©¦æ¸²æŸ“ UIï¼Œé¿å…å¡åœ¨è¼‰å…¥ä¸­
                showModal('éŒ¯èª¤', 'ç„¡æ³•é€£æ¥åˆ°è³‡æ–™åº«ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šã€‚');
                renderUI(); 
            });
        };

        const saveSample = async (data) => {
            const colRef = getSamplesCollectionRef();
            if (!colRef) {
                showModal('éŒ¯èª¤', 'è³‡æ–™åº«æœå‹™å°šæœªæº–å‚™å¥½ã€‚', 'alert-octagon');
                return;
            }

            try {
                if (data.id) {
                    const docRef = doc(colRef, data.id);
                    await updateDoc(docRef, {
                        title: data.title,
                        content_ch: data.content_ch,
                        content_en: data.content_en,
                        category: data.category,
                        timestamp: serverTimestamp()
                    });
                    showModal('æˆåŠŸ', 'æ¨£æœ¬å·²æˆåŠŸæ›´æ–°ï¼', 'check-circle');
                } else {
                    await addDoc(colRef, {
                        title: data.title || 'ç„¡æ¨™é¡Œæ¨£æœ¬',
                        content_ch: data.content_ch || '',
                        content_en: data.content_en || '',
                        category: data.category || 'æœªåˆ†é¡',
                        timestamp: serverTimestamp()
                    });
                    showModal('æˆåŠŸ', 'æ–°çš„æ–‡å­—æ¨£æœ¬å·²å»ºç«‹ï¼', 'plus-circle');
                }
            } catch (error) {
                console.error("Error saving sample:", error);
                showModal('éŒ¯èª¤', `å„²å­˜å¤±æ•—: ${error.message}`);
            }
        };

        const deleteSample = async (id) => {
            if (!id) return;
            const colRef = getSamplesCollectionRef();
            if (!colRef) {
                showModal('éŒ¯èª¤', 'è³‡æ–™åº«æœå‹™å°šæœªæº–å‚™å¥½ã€‚', 'alert-octagon');
                return;
            }

            try {
                const docRef = doc(colRef, id);
                await deleteDoc(docRef);
                showModal('åˆªé™¤æˆåŠŸ', 'æ–‡å­—æ¨£æœ¬å·²ç§»é™¤ã€‚', 'trash-2');
            } catch (error) {
                console.error("Error deleting sample:", error);
                showModal('éŒ¯èª¤', `åˆªé™¤å¤±æ•—: ${error.message}`);
            }
        };
        
        // --- 5. UI è¼”åŠ©èˆ‡æ¨¡æ…‹æ¡†é‚è¼¯ (ä¿æŒä¸è®Š) ---

        // éš±è—æ¨¡æ…‹æ¡†
        const hideModal = () => {
            const modal = document.getElementById('custom-modal');
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0', 'pointer-events-none');
        };

        // é¡¯ç¤ºè‡ªå®šç¾©æ¨¡æ…‹æ¡† (ç”¨æ–¼ä»£æ›¿ alert/confirm)
        const showModal = (title, message, icon = 'info') => {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            
            const iconHtml = `<i data-lucide="${icon}" class="lucide-icon text-indigo-600 w-6 h-6 mr-2"></i>`;
            document.getElementById('modal-icon-container').innerHTML = iconHtml;
            lucide.createIcons();

            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100');

            // 5ç§’å¾Œè‡ªå‹•é—œé–‰
            setTimeout(() => {
                hideModal();
            }, 5000);
        };
        
        // è™•ç†åˆªé™¤ç¢ºèª 
        const handleDeleteClick = (id) => {
            const modal = document.getElementById('confirm-modal');
            
            document.getElementById('confirm-message').textContent = 'æ‚¨ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤æ–‡å­—æ¨£æœ¬å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚';
            
            const confirmBtn = document.getElementById('confirm-action-btn');
            confirmBtn.onclick = () => {
                deleteSample(id);
                hideConfirmModal();
            };

            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100');
        };

        const hideConfirmModal = () => {
            const modal = document.getElementById('confirm-modal');
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0', 'pointer-events-none');
        };

        const showAddSampleModal = () => {
            updateNewSampleCategoryOptions();
            const modal = document.getElementById('add-sample-modal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100');
            
            document.getElementById('new-title').value = '';
            document.getElementById('new-content').value = '';
            document.getElementById('new-category').value = 'æœªåˆ†é¡';
            document.getElementById('draft-prompt').value = ''; // Clear prompt
            lucide.createIcons();
        };

        const hideAddSampleModal = () => {
            const modal = document.getElementById('add-sample-modal');
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0', 'pointer-events-none');
        };
        
        const showAddCategoryModal = () => {
            const modal = document.getElementById('add-category-modal');
            document.getElementById('new-category-name').value = '';
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100');
            lucide.createIcons();
        };

        const hideAddCategoryModal = () => {
            const modal = document.getElementById('add-category-modal');
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0', 'pointer-events-none');
        };

        const addNewCategoryAndFilter = async () => {
            const categoryNameInput = document.getElementById('new-category-name');
            const newCategoryName = categoryNameInput.value.trim();

            if (!newCategoryName) {
                showModal('éŒ¯èª¤', 'åˆ†é¡åç¨±ä¸èƒ½ç‚ºç©ºã€‚', 'alert-octagon');
                return;
            }
            
            const existingCategories = getCategories().filter(c => c !== 'å…¨éƒ¨');
            if (existingCategories.includes(newCategoryName)) {
                showModal('æ³¨æ„', `åˆ†é¡ "${newCategoryName}" å·²ç¶“å­˜åœ¨ã€‚å·²ç‚ºæ‚¨åˆ‡æ›è‡³è©²ç¯©é¸å™¨ã€‚`, 'alert-triangle');
                setCategoryFilter(newCategoryName);
                hideAddCategoryModal();
                return;
            }

            const placeholderSample = {
                title: `æ–°åˆ†é¡é ç•™é …ç›®: ${newCategoryName}`,
                content: `é€™æ˜¯ç‚ºæ–°åˆ†é¡ã€Œ${newCategoryName}ã€å»ºç«‹çš„é ç•™æ¨£æœ¬ã€‚è«‹ç·¨è¼¯æˆ–åˆªé™¤æ­¤é …ç›®ã€‚`,
                category: newCategoryName
            };

            try {
                await saveSample(placeholderSample);
                setCategoryFilter(newCategoryName);
                hideAddCategoryModal();
                showModal('åˆ†é¡æ–°å¢æˆåŠŸ', `å·²å»ºç«‹æ–°åˆ†é¡ã€Œ${newCategoryName}ã€ä¸¦åˆ‡æ›ç¯©é¸ã€‚`, 'folder-check');
            } catch (error) {
                showModal('éŒ¯èª¤', `ç„¡æ³•æ–°å¢åˆ†é¡: ${error.message}`, 'alert-octagon');
            }
        };

        const toggleEditMode = (id) => {
            const sampleCard = document.getElementById(`sample-${id}`);
            if (!sampleCard) return;

            const isCurrentlyEditing = activeEditId === id;

            if (isCurrentlyEditing) {
                const titleInput = sampleCard.querySelector('#edit-title');
                const contentChInput = sampleCard.querySelector('#edit-content-ch');
                const contentEnInput = sampleCard.querySelector('#edit-content-en');
                const categorySelect = sampleCard.querySelector('#edit-category');
                
                const updatedSample = {
                    id: id,
                    title: titleInput.value,
                    content_ch: contentChInput.value,
                    content_en: contentEnInput.value,
                    category: categorySelect.value
                };
                
                saveSample(updatedSample);
                activeEditId = null;

            } else {
                if (activeEditId) {
                    activeEditId = null;
                    renderUI(); 
                }
                activeEditId = id;
            }
            renderUI();
        };

        const setCategoryFilter = (category) => {
            currentCategoryFilter = category;
            renderUI();
        };

        const getCategories = () => {
            const categorySet = new Set(samples.map(s => s.category).filter(c => c));
            return ['å…¨éƒ¨', ...Array.from(categorySet)].sort();
        };
        
        const updateNewSampleCategoryOptions = () => {
            const categories = getCategories();
            const categorySelect = document.getElementById('new-category');
            if (!categorySelect) return;

            const categoryOptions = categories.filter(c => c !== 'å…¨éƒ¨').map(cat => 
                `<option value="${cat}">${cat}</option>`
            ).join('');

            categorySelect.innerHTML = `
                <option value="æœªåˆ†é¡">æœªåˆ†é¡</option>
                ${categoryOptions}
                <option value="æ–°å¢åˆ†é¡">--- è«‹ä½¿ç”¨ç¯©é¸å™¨å€åŸŸæŒ‰éˆ• ---</option>
            `;
        };
        
        // --- 6. è™•ç†ä¸­/ç¿»è­¯æ¨¡æ…‹æ¡† (ä¿æŒä¸è®Š) ---
        const showProcessingModal = (title, message) => {
            const modal = document.getElementById('processing-modal');
            document.getElementById('processing-title').textContent = title;
            document.getElementById('processing-message').textContent = message;
            
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100');
            lucide.createIcons();
        };

        const hideProcessingModal = () => {
            const modal = document.getElementById('processing-modal');
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0', 'pointer-events-none');
        };

        // AI ç¿»è­¯çµæœæ¨¡æ…‹æ¡†
        const showTranslationModal = (id, translation, originalContent) => {
            const modal = document.getElementById('translation-modal');
            document.getElementById('translation-content-display').innerHTML = translation.replace(/\n/g, '<br>');
            
            const replaceBtn = document.getElementById('translation-replace-btn');
            replaceBtn.onclick = () => {
                // æ‰¾åˆ°åŸå§‹æ¨£æœ¬ç‰©ä»¶
                const sampleToUpdate = samples.find(s => s.id === id);
                if (sampleToUpdate) {
                    // åŸ·è¡Œæ›´æ–°
                    const updatedSample = {
                        id: id,
                        title: sampleToUpdate.title,
                        content: translation.trim(), // ç”¨ç¿»è­¯å…§å®¹æ›¿æ›å…§å®¹
                        category: sampleToUpdate.category
                    };
                    saveSample(updatedSample);
                }
                hideTranslationModal();
            };

            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100');
            lucide.createIcons();
        };

        const hideTranslationModal = () => {
            const modal = document.getElementById('translation-modal');
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0', 'pointer-events-none');
        };

        // --- 7. Gemini ç¿»è­¯åŠŸèƒ½ (ä¿æŒä¸è®Š) ---
        const translateSample = async (id, originalContent) => {
            if (!originalContent.trim().length) {
                 showModal('æ³¨æ„', 'æ¨£æœ¬å…§å®¹ç‚ºç©ºï¼Œç„¡æ³•ç¿»è­¯ã€‚', 'alert-triangle');
                 return;
            }

            showProcessingModal('æ­£åœ¨ç¿»è­¯', 'Gemini æ­£åœ¨å°‡æ‚¨çš„æ–‡æœ¬ç¿»è­¯æˆè‹±æ–‡...');
            
            try {
                const systemPrompt = "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ç¿»è­¯å®¶ã€‚è«‹å°‡ä½¿ç”¨è€…æä¾›çš„æ–‡æœ¬ç²¾æº–ã€æµæš¢åœ°ç¿»è­¯æˆå°ˆæ¥­çš„**è‹±æ–‡**ã€‚åƒ…è¿”å›ç¿»è­¯å¾Œçš„æ–‡æœ¬å…§å®¹ï¼Œä¸è¦åŒ…å«ä»»ä½•é¡å¤–çš„èªªæ˜æˆ–è¨»é‡‹ã€‚";
                const translation = await callGemini(originalContent, systemPrompt);
                
                hideProcessingModal();
                showTranslationModal(id, translation, originalContent);
                
            } catch (error) {
                hideProcessingModal();
                console.error("Translation failed:", error);
                showModal('ç¿»è­¯éŒ¯èª¤', `ç„¡æ³•ç”Ÿæˆç¿»è­¯ï¼š${error.message}`, 'alert-octagon');
            }
        };
        
        // --- 8. Gemini è‰ç¨¿ç”ŸæˆåŠŸèƒ½ (ä¿æŒä¸è®Š) ---
        const generateDraft = async () => {
            const draftPrompt = document.getElementById('draft-prompt').value.trim();
            const contentTextarea = document.getElementById('new-content');

            if (!draftPrompt) {
                showModal('æç¤º', 'è«‹è¼¸å…¥æ‚¨çš„è‰ç¨¿éœ€æ±‚æè¿°ï¼', 'alert-triangle');
                return;
            }
            
            showProcessingModal('æ­£åœ¨ç”Ÿæˆè‰ç¨¿', 'Gemini æ­£åœ¨æ ¹æ“šæ‚¨çš„éœ€æ±‚å¯«ä½œ...');
            
            try {
                const systemPrompt = "ä½ æ˜¯ä¸€ä½é ‚å°–çš„æ–‡æ¡ˆè¨­è¨ˆå¸«ã€‚è«‹æ ¹æ“šä½¿ç”¨è€…çš„è¦æ±‚ï¼Œä»¥ç¹é«”ä¸­æ–‡å¯«ä½œä¸€ç¯‡å°ˆæ¥­çš„æ–‡æœ¬è‰ç¨¿ã€‚åƒ…è¿”å›æ–‡æœ¬å…§å®¹ï¼Œä¸è¦åŒ…å«ä»»ä½•é–‹é ­æˆ–çµå°¾çš„è¨»é‡‹ã€‚";
                const generatedContent = await callGemini(draftPrompt, systemPrompt);
                
                // æˆåŠŸå¾Œå°‡ç”Ÿæˆçš„å…§å®¹å¡«å…¥ textarea
                contentTextarea.value = generatedContent.trim();
                // ä½¿ç”¨æç¤ºä½œç‚ºæ¨™é¡Œå‰ç¶´
                document.getElementById('new-title').value = `AI è‰ç¨¿: ${draftPrompt.substring(0, 30)}${draftPrompt.length > 30 ? '...' : ''}`;
                
                hideProcessingModal();
                showModal('ç”ŸæˆæˆåŠŸ', 'è‰ç¨¿å·²æˆåŠŸå¡«å…¥å…§å®¹æ¬„ä½ï¼Œè«‹æª¢æŸ¥å’Œä¿®æ”¹ã€‚', 'check-circle');
                
            } catch (error) {
                hideProcessingModal();
                console.error("Draft generation failed:", error);
                showModal('ç”ŸæˆéŒ¯èª¤', `ç„¡æ³•ç”Ÿæˆè‰ç¨¿ï¼š${error.message}`, 'alert-octagon');
            }
        };


        // --- 9. ä¸»æ¸²æŸ“å‡½å¼ï¼šä¿®å¾©é¦–æ®µè½ç©ºä½ä¸¦æ–°å¢æŒ‰éˆ• (ä¿æŒä¸è®Š) ---
        const renderSampleCard = (sample) => {
            const date = sample.timestamp ? new Date(sample.timestamp.seconds * 1000).toLocaleString('zh-TW', {
                year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit'
            }) : 'å°šæœªå„²å­˜';

            const categories = getCategories();
            const categoryOptions = categories.filter(c => c !== 'å…¨éƒ¨').map(cat => 
                `<option value="${cat}" ${sample.category === cat ? 'selected' : ''}>${cat}</option>`
            ).join('');
            if (!categories.includes(sample.category) && sample.category) {
                 categoryOptions.unshift(`<option value="${sample.category}" selected>${sample.category}</option>`);
            }
            
            const editCategorySelect = `
                <select id="edit-category" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                    ${categoryOptions}
                    <option value="æœªåˆ†é¡" ${sample.category === 'æœªåˆ†é¡' ? 'selected' : ''}>æœªåˆ†é¡</option>
                </select>
            `;

            const isEditing = activeEditId === sample.id;

            // ç”¨ JSON.stringify åŒ…è£ sample.content ä¸¦ä½¿ç”¨åå¼•è™Ÿæ¨¡æ¿ï¼Œç¢ºä¿å…§å®¹èƒ½æ­£ç¢ºå‚³éçµ¦ translateSample å‡½å¼
            const escapedContent = JSON.stringify(sample.content).slice(1, -1).replace(/\\/g, '\\\\').replace(/'/g, '\\\'');

            // ä¿®æ­£ï¼šä½¿ç”¨ .trim() ç§»é™¤é¦–å°¾ç©ºç™½å’Œç©ºè¡Œï¼Œè§£æ±ºé¦–æ®µè½ç©ºä½å•é¡Œ
            const displayContent = (sample.content_ch || "").trim().replace(/\n/g, '<br>');

            return `
                <div id="sample-${sample.id}" class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition duration-300 flex flex-col h-full border-t-4 border-indigo-500">
                    <div class="flex justify-between items-start mb-4">
                        ${isEditing ? `
                            <input id="edit-title" value="${sample.title}" class="text-xl font-bold text-gray-800 w-full border-b border-gray-300 p-1 mb-2 focus:outline-none focus:border-indigo-500">
                        ` : `
                            <h3 class="text-xl font-bold text-gray-800">${sample.title}</h3>
                        `}
                        <div class="flex-shrink-0 ml-4 flex space-x-2">
                            ${isEditing ? '' : `
                                <!-- AI ç¿»è­¯æŒ‰éˆ• -->
                                
                            `}
                            <button onclick="window.app.toggleEditMode('${sample.id}')" class="text-white ${isEditing ? 'bg-green-500 hover:bg-green-600' : 'bg-indigo-500 hover:bg-indigo-600'} p-2 rounded-full shadow-md transition duration-150">
                                <i data-lucide="${isEditing ? 'save' : 'edit'}" class="lucide-icon w-4 h-4"></i>
                            </button>
                            ${isEditing ? '' : `
                                <button onclick="window.app.handleDeleteClick('${sample.id}')" class="text-white bg-red-500 hover:bg-red-600 p-2 rounded-full shadow-md transition duration-150">
                                    <i data-lucide="trash-2" class="lucide-icon w-4 h-4"></i>
                                </button>
                            `}
                        </div>
                    </div>

                    <div class="mb-4 text-sm font-medium text-indigo-600 flex items-center">
                        <i data-lucide="tag" class="lucide-icon w-4 h-4 mr-1"></i>
                        ${isEditing ? editCategorySelect : `
                            <span class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-semibold">${sample.category}</span>
                        `}
                    </div>
                    
                    ${isEditing ? `
                        <textarea id="edit-content" class="flex-grow w-full h-48 border border-gray-300 p-3 rounded-lg resize-y focus:ring-indigo-500 focus:border-indigo-500 text-gray-700">${sample.content}</textarea>
                    ` : `
                        <div class="flex-grow text-gray-700 sample-content overflow-auto mb-4 border p-3 rounded-lg bg-gray-50 max-h-64">
                            ${displayContent}
                        </div>
                    `}

                    <p class="text-xs text-gray-500 mt-auto pt-2 border-t border-gray-100">
                        æœ€å¾Œç·¨è¼¯æ–¼: ${date}
                    </p>
                </div>
            `;
        };
        
        const createNewSample = () => {
            const titleInput = document.getElementById('new-title');
            const contentChInput = document.getElementById('new-content-ch');
            const contentEnInput = document.getElementById('new-content-en');
            const categorySelect = document.getElementById('new-category');
            
            let category = categorySelect.value;
            
            if (category === 'æ–°å¢åˆ†é¡') {
                showModal('æ³¨æ„', 'è«‹åœ¨ä¸Šæ–¹ã€Œç¯©é¸å™¨ã€å€åŸŸä½¿ç”¨ã€Œæ–°å¢åˆ†é¡ã€æŒ‰éˆ•ä¾†å»ºç«‹æ–°åˆ†é¡ï¼Œæˆ–é¸æ“‡ä¸€å€‹ç¾æœ‰çš„åˆ†é¡ã€‚', 'alert-triangle');
                return; 
            }
            
            const newSample = {
                title: titleInput.value || 'ç„¡æ¨™é¡Œæ¨£æœ¬',
                content_ch: contentChInput.value || '',
                content_en: contentEnInput.value || '',
                category: category
            };

            if (!newSample.content_ch.trim() && !newSample.content_en.trim()) {
                showModal('æ³¨æ„', 'å…§å®¹ä¸èƒ½ç‚ºç©ºï¼', 'alert-triangle');
                return;
            }

            saveSample(newSample).then(() => {
                titleInput.value = '';
                contentChInput.value = '';
                contentEnInput.value = '';
                categorySelect.value = 'æœªåˆ†é¡';
                document.getElementById('draft-prompt').value = ''; // Clear prompt
                hideAddSampleModal();
            });
        };

        const renderUI = () => {
            const samplesContainer = document.getElementById('samples-container');
            const filterContainer = document.getElementById('filter-container');
            
            // ğŸš¨ é é˜²æ€§æª¢æŸ¥
            if (!samplesContainer || !filterContainer) return;
            
            const categories = getCategories();
            const filteredSamples = currentCategoryFilter === 'å…¨éƒ¨'
                ? samples
                : samples.filter(s => s.category === currentCategoryFilter);

            filterContainer.innerHTML = categories.map(cat => `
                <button 
                    onclick="window.app.setCategoryFilter('${cat}')"
                    class="px-4 py-2 text-sm font-semibold rounded-full transition duration-150 ${currentCategoryFilter === cat 
                        ? 'bg-indigo-600 text-white shadow-lg' 
                        : 'bg-white text-gray-700 hover:bg-indigo-100 border border-gray-300'}"
                >
                    ${cat} (${cat === 'å…¨éƒ¨' ? samples.length : samples.filter(s => s.category === cat).length})
                </button>
            `).join('') + `
                <button 
                    onclick="window.app.showAddCategoryModal()"
                    class="px-4 py-2 text-sm font-semibold rounded-full transition duration-150 bg-indigo-50 border border-indigo-300 text-indigo-700 hover:bg-indigo-200 flex items-center"
                >
                    <i data-lucide="plus" class="lucide-icon w-4 h-4 mr-1"></i>
                    æ–°å¢åˆ†é¡
                </button>
            `;

            if (filteredSamples.length === 0) {
                // åªæœ‰åœ¨æ¨£æœ¬ç‚ºç©ºæ™‚æ‰é¡¯ç¤ºåŠ è¼‰æç¤ºï¼Œå¦å‰‡æ‡‰è©²é¡¯ç¤ºã€Œæ­£åœ¨è¼‰å…¥æ‚¨çš„ä½œå“...ã€
                // å¦‚æœ samples ç‚ºç©ºï¼Œä½† userId å·²ç¶“è¨­ç½®ï¼Œå‰‡é¡¯ç¤ºå‰µå»ºæç¤º
                if (samples.length === 0 && userId) {
                     samplesContainer.innerHTML = `
                        <div class="col-span-full text-center py-10 bg-white rounded-xl shadow-inner text-gray-500">
                            <i data-lucide="book-open" class="lucide-icon w-12 h-12 mx-auto mb-4 text-gray-300"></i>
                            <p class="text-lg">ç›®å‰åœ¨é€™å€‹åˆ†é¡ä¸­æ²’æœ‰æ–‡å­—æ¨£æœ¬ã€‚</p>
                            <p class="text-sm">é»æ“Šå³ä¸Šè§’çš„ã€Œæ–°å¢æ–‡å­—æ¨£æœ¬ã€æŒ‰éˆ•é–‹å§‹å‰µå»ºå§ï¼</p>
                        </div>
                    `;
                } else if (!userId) {
                    // ğŸš¨ å¦‚æœç”¨æˆ¶ ID é‚„æ²’æ‹¿åˆ°ï¼Œä¿æŒåŸå§‹çš„åŠ è¼‰ä¸­ç‹€æ…‹
                    samplesContainer.innerHTML = `
                        <div class="col-span-full text-center py-10 text-gray-400">
                            <i data-lucide="loader" class="lucide-icon w-8 h-8 mx-auto mb-2 animate-spin"></i>
                            <p>æ­£åœ¨è¼‰å…¥æ‚¨çš„ä½œå“...</p>
                        </div>
                    `;
                } else {
                    // å·²ç¶“è¼‰å…¥éè³‡æ–™ï¼Œä½†åœ¨ç•¶å‰åˆ†é¡ä¸‹æ²’æœ‰æ¨£æœ¬
                     samplesContainer.innerHTML = `
                        <div class="col-span-full text-center py-10 bg-white rounded-xl shadow-inner text-gray-500">
                            <i data-lucide="folder-open" class="lucide-icon w-12 h-12 mx-auto mb-4 text-gray-300"></i>
                            <p class="text-lg">æ­¤åˆ†é¡ã€Œ${currentCategoryFilter}ã€ä¸­æ²’æœ‰ä»»ä½•æ¨£æœ¬ã€‚</p>
                            <p class="text-sm">è«‹åˆ‡æ›åˆ†é¡æˆ–æ–°å¢æ¨£æœ¬ã€‚</p>
                        </div>
                    `;
                }
            } else {
                samplesContainer.innerHTML = filteredSamples.map(renderSampleCard).join('');
            }
            
            lucide.createIcons();
        };

        // --- 10. å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼ ---
        window.app = {
            copyText: function(sampleId, lang) {
                const sample = samples.find(s => s.id === sampleId);
                if (!sample) return;
                const textToCopy = lang === 'ch' ? sample.content_ch : sample.content_en;
                if (!textToCopy) {
                    showModal('æ³¨æ„', 'è©²èªè¨€å…§å®¹ç‚ºç©ºï¼Œç„¡æ³•è¤‡è£½ã€‚', 'alert-triangle');
                    return;
                }
                navigator.clipboard.writeText(textToCopy).then(() => {
                    const langText = lang === 'ch' ? 'ä¸­æ–‡' : 'è‹±æ–‡';
                    showModal('æˆåŠŸ', `${langText}å…§å®¹å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼`, 'check-circle');
                }).catch(err => {
                    console.error('Copy failed', err);
                    showModal('éŒ¯èª¤', 'è¤‡è£½å¤±æ•—', 'alert-octagon');
                });
            },

            setCategoryFilter,
            toggleEditMode,
            createNewSample,
            handleDeleteClick,
            hideConfirmModal,
            showAddSampleModal,
            hideAddSampleModal,
            showAddCategoryModal,
            hideAddCategoryModal,
            addNewCategoryAndFilter,
            hideModal, 
            saveSample,
            renderUI,
             
            
             
        };
        
        window.onload = () => {
            // æª¢æŸ¥ Firebase æ˜¯å¦æˆåŠŸåˆå§‹åŒ–ï¼Œå¦‚æœå¤±æ•—ï¼Œå‰‡ä¸éœ€è¦èª¿ç”¨ signInAndListen
            if (auth && db) {
                signInAndListen();
            } else {
                console.warn("Firebase æœªæˆåŠŸåˆå§‹åŒ–ï¼Œè·³éèªè­‰æµç¨‹ã€‚");
                // é€™è£¡ç„¡éœ€èª¿ç”¨ renderUIï¼Œå› ç‚ºåˆå§‹åŒ–å¤±æ•—çš„éŒ¯èª¤è¨Šæ¯å·²ç¶“é¡¯ç¤ºåœ¨ app-container ä¸­
            }
        };

    </script>
</head>
<body class="bg-gray-50 min-h-screen">

    
    </div>
    
    
    </div>


    <!-- è‡ªå®šç¾©è¨Šæ¯æ¨¡æ…‹æ¡† (Custom Modal) -->
    <div id="custom-modal" class="custom-modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-95" onclick="event.stopPropagation()">
            <div class="flex items-center mb-4">
                <span id="modal-icon-container"></span>
                <h3 id="modal-title" class="text-lg font-bold text-gray-800">è¨Šæ¯</h3>
                <button onclick="window.app.hideModal()" class="ml-auto text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="lucide-icon w-5 h-5"></i>
                </button>
            </div>
            <p id="modal-message" class="text-gray-600 mb-4"></p>
            <div class="flex justify-end">
                <button onclick="window.app.hideModal()" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition duration-150">ç¢ºå®š</button>
            </div>
        </div>
    </div>
    
    <!-- ç¢ºèªåˆªé™¤æ¨¡æ…‹æ¡† (Confirm Modal) -->
    <div id="confirm-modal" class="custom-modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-95" onclick="event.stopPropagation()">
            <div class="flex items-center mb-4">
                <i data-lucide="alert-triangle" class="lucide-icon text-red-500 w-6 h-6 mr-2"></i>
                <h3 class="text-lg font-bold text-gray-800">ç¢ºèªæ“ä½œ</h3>
            </div>
            <p id="confirm-message" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button onclick="window.app.hideConfirmModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150">å–æ¶ˆ</button>
                <button id="confirm-action-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150">ç¢ºèªåˆªé™¤</button>
            </div>
        </div>
    </div>
    
    <!-- æ–°å¢æ¨£æœ¬æ¨¡æ…‹æ¡† (Add Sample Modal) -->
    <div id="add-sample-modal" class="custom-modal fixed inset-0 z-40 flex items-center justify-center bg-black bg-opacity-70 opacity-0 pointer-events-none" onclick="window.app.hideAddSampleModal()">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-4xl w-full transform transition-all duration-300 modal-content-transition scale-90" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h2 class="text-2xl font-extrabold text-indigo-800 flex items-center">
                    <i data-lucide="plus-square" class="lucide-icon w-6 h-6 mr-2"></i>
                    æ–°å¢æ–‡å­—æ¨£æœ¬
                </h2>
                <button onclick="window.app.hideAddSampleModal()" class="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100">
                    <i data-lucide="x" class="lucide-icon w-6 h-6"></i>
                </button>
            </div>
            
            <div class="bg-white" id="add-new-sample-form">
                
                <!-- AI è‰ç¨¿ç”Ÿæˆå€å¡Š -->
                <div class="mb-6 p-4 border border-blue-200 bg-blue-50 rounded-lg shadow-inner">
                    <h3 class="text-lg font-bold text-blue-700 flex items-center mb-2">
                        <i data-lucide="sparkles" class="lucide-icon w-5 h-5 mr-2"></i>
                        AI æ™ºèƒ½è‰ç¨¿ç”Ÿæˆ
                    </h3>
                    <p class="text-sm text-gray-600 mb-2">è«‹è¼¸å…¥æ‚¨æƒ³è¦ AI æ’°å¯«çš„å…§å®¹æè¿°ï¼š</p>
                    <div class="flex space-x-3">
                        <input type="text" id="draft-prompt" class="flex-grow rounded-md border-gray-300 shadow-sm p-3 focus:border-blue-500 focus:ring-blue-500" placeholder="ä¾‹å¦‚ï¼šä¸€ç¯‡ä»‹ç´¹ App æ–°åŠŸèƒ½çš„éŠ·å”®æ–‡æ¡ˆ">
                        <button onclick="window.app.generateDraft()" class="flex-shrink-0 inline-flex items-center px-4 py-3 border border-transparent text-sm font-medium rounded-full shadow-md text-white bg-blue-600 hover:bg-blue-700 transition duration-150">
                            <i data-lucide="pen-tool" class="lucide-icon w-5 h-5 mr-1"></i>
                            ç”Ÿæˆè‰ç¨¿
                        </button>
                    </div>
                </div>

                <!-- å‚³çµ±æ‰‹å‹•è¼¸å…¥å€å¡Š -->
                <p class="text-sm text-gray-700 mb-4">æˆ–æ‰‹å‹•å¡«å¯«ä»¥ä¸‹æ¬„ä½ï¼š</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="md:col-span-2">
                        <label for="new-title" class="block text-sm font-medium text-gray-700">æ¨™é¡Œ</label>
                        <input type="text" id="new-title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="è¼¸å…¥æ¨£æœ¬æ¨™é¡Œ">
                    </div>
                    <div>
                        <label for="new-category" class="block text-sm font-medium text-gray-700">åˆ†é¡</label>
                        <select id="new-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500">
                            <option value="æœªåˆ†é¡">æœªåˆ†é¡</option>
                            <option value="æ–°å¢åˆ†é¡">--- è«‹ä½¿ç”¨ç¯©é¸å™¨å€åŸŸæŒ‰éˆ• ---</option>
                        </select>
                    </div>
                </div>
                <label for="new-content" class="block text-sm font-medium text-gray-700 mb-1">å…§å®¹</label>
                <textarea id="new-content" rows="10" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="åœ¨æ­¤è¼¸å…¥æ‚¨çš„æ–‡å­—å…§å®¹..."></textarea>
                
                <button onclick="window.app.createNewSample()" class="mt-4 w-full md:w-auto inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-full shadow-lg text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                    <i data-lucide="send" class="lucide-icon w-5 h-5 mr-2"></i>
                    å„²å­˜æ¨£æœ¬
                </button>
            </div>
        </div>
    </div>
    
    <!-- æ–°å¢åˆ†é¡æ¨¡æ…‹æ¡† (Add Category Modal) -->
    <div id="add-category-modal" class="custom-modal fixed inset-0 z-40 flex items-center justify-center bg-black bg-opacity-70 opacity-0 pointer-events-none" onclick="window.app.hideAddCategoryModal()">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-md w-full transform transition-all duration-300 modal-content-transition scale-90" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h2 class="text-xl font-extrabold text-indigo-800 flex items-center">
                    <i data-lucide="folder-plus" class="lucide-icon w-5 h-5 mr-2"></i>
                    æ–°å¢ç¯©é¸åˆ†é¡
                </h2>
                <button onclick="window.app.hideAddCategoryModal()" class="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100">
                    <i data-lucide="x" class="lucide-icon w-6 h-6"></i>
                </button>
            </div>
            <label for="new-category-name" class="block text-sm font-medium text-gray-700 mb-1">åˆ†é¡åç¨±</label>
            <input type="text" id="new-category-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="ä¾‹å¦‚ï¼šéƒ¨è½æ ¼æ–‡ç« , ç”¢å“æè¿°">
            
            <button onclick="window.app.addNewCategoryAndFilter()" class="mt-4 w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-full shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                <i data-lucide="check" class="lucide-icon w-4 h-4 mr-2"></i>
                æ–°å¢ä¸¦ç¯©é¸
            </button>
        </div>
    </div>


    <!-- ä¸»è¦å…§å®¹å€å¡Š -->
    <div id="app-container" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">

        <!-- Header and Action Bar -->
        <header class="mb-8 p-4 bg-white rounded-xl shadow-md flex justify-between items-start flex-wrap gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-gray-900 flex items-center">
                    <i data-lucide="feather" class="lucide-icon text-indigo-500 w-8 h-8 mr-3"></i>
                    æˆ‘çš„æ–‡å­—æ¨£æœ¬åº« (AI å¢å¼·)
                </h1>
                <p class="text-gray-500 mt-1">åœ¨é€™è£¡ç®¡ç†å’Œä¿®æ”¹æ‚¨çš„æ–‡å­—ä½œå“é›†ã€‚</p>
                <div id="auth-status" class="mt-2">
                    <span class="text-sm text-gray-500">æ­£åœ¨é€£æ¥...</span>
                </div>
            </div>
            
            <!-- æ–°å¢æ¨£æœ¬æŒ‰éˆ• (ç§»åˆ°å³ä¸Šè§’) -->
            <div id="header-actions" class="text-right flex-shrink-0">
                <button onclick="window.app.showAddSampleModal()" class="inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-full shadow-lg text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150">
                    <i data-lucide="plus" class="lucide-icon w-5 h-5 mr-2"></i>
                    æ–°å¢æ–‡å­—æ¨£æœ¬
                </button>
            </div>
        </header>
        
        <!-- ç¯©é¸å™¨ -->
        <div class="mb-6 p-4 bg-white rounded-xl shadow-md">
            <h2 class="text-xl font-semibold text-gray-700 mb-3 flex items-center">
                <i data-lucide="filter" class="lucide-icon w-5 h-5 mr-2 text-indigo-500"></i>
                åˆ†é¡ç¯©é¸
            </h2>
            <div id="filter-container" class="flex flex-wrap gap-2">
                <button class="px-4 py-2 text-sm font-semibold rounded-full bg-indigo-600 text-white shadow-lg">å…¨éƒ¨ (0)</button>
            </div>
        </div>

        <!-- æ¨£æœ¬åˆ—è¡¨ -->
        <div id="samples-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="col-span-full text-center py-10 text-gray-400">
                <i data-lucide="loader" class="lucide-icon w-8 h-8 mx-auto mb-2 animate-spin"></i>
                <p>æ­£åœ¨è¼‰å…¥æ‚¨çš„ä½œå“...</p>
            </div>
        </div>

        <!-- Footer for padding -->
        <div class="h-10"></div>
    </div>

</body>
</html>

