<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文字樣本與作品集</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@100..900&display=swap');
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        .sample-content {
            white-space: pre-wrap;
        }
        .custom-modal {
            transition: opacity 0.3s ease-in-out;
        }
        .lucide {
            width: 1.25rem;
            height: 1.25rem;
        }
        .modal-content-transition {
            transition: transform 0.3s ease-out;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp, orderBy, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        setLogLevel('Debug');
        
        // --- 1. 全域變數、設定檔與初始化 ---
        const appId = 'default-app-id';
        
        // 替換為您的 Firebase 設定
        const firebaseConfig = {
          apiKey: "AIzaSyBnQmqGZQ_94BDgmZFzOJsKDjgYq8ipI2I",
          authDomain: "hkttext.firebaseapp.com",
          projectId: "hkttext",
          storageBucket: "hkttext.firebasestorage.app",
          messagingSenderId: "501339425536",
          appId: "1:501339425536:web:f9ddbf080a002be99701e5",
          measurementId: "G-CKY8VPMJXJ"
        };

        // 設定環境變數供下方使用
        let envFirebaseConfig = firebaseConfig;

        let app, db, auth, userId = null;
        let samples = [];
        let currentCategoryFilter = '全部';
        let activeEditId = null;

        // 初始化 Firebase 服務
        if (envFirebaseConfig) {
            try {
                app = initializeApp(envFirebaseConfig);
                const analytics = getAnalytics(app);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (error) {
                console.error("Firebase 初始化失敗:", error);
                document.getElementById('app-container').innerHTML = `
                    <div class="p-6 bg-red-100 border border-red-400 text-red-700 rounded-lg max-w-lg mx-auto mt-10">
                        <p class="font-bold">設定錯誤</p>
                        <p>Firebase 初始化失敗。請檢查您的設定。</p>
                        <p class="text-xs mt-2">錯誤訊息: ${error.message}</p>
                    </div>
                `;
            }
        }

        // --- 3. 認證與使用者設定 ---
        const signInAndListen = async () => {
            if (!auth || !db) return;
            
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Firebase Authentication failed:", error);
                showModal('認證錯誤', `無法連接到 Firebase 認證服務：${error.message}`, 'alert-octagon');
                return;
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('auth-status').innerHTML = `
                        <span class="hidden" id="actual-user-id">${userId}</span>
                        <span class="text-sm text-gray-500 flex items-center" title="已連接 Firebase 資料庫">
                            <i data-lucide="database" class="lucide-icon w-4 h-4 mr-1 text-indigo-500"></i>
                            已連接資料庫
                        </span>
                    `;
                    lucide.createIcons();
                    renderUI(); 
                    if (db) listenForSamples();
                } else {
                    userId = null;
                    renderUI(); 
                }
            });
        };

        // ... (保留原本的 Firestore 函式: getSamplesCollectionRef, listenForSamples, saveSample, deleteSample) ...
        // ... (這些函式未變動，因此省略以節省篇幅，請保留原檔案中的內容) ...
        
        // 注意：以下是您需要保留的 Firestore 操作函式，請確認這些部分存在
        const getSamplesCollectionRef = () => {
            if (!userId || !db) return null;
            return collection(db, `artifacts/${appId}/users/${userId}/text_samples`);
        };

        const listenForSamples = () => {
            const colRef = getSamplesCollectionRef();
            if (!colRef) return;
            const q = query(colRef);
            onSnapshot(q, (snapshot) => {
                samples = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                samples.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                renderUI();
            });
        };

        const saveSample = async (data) => {
             const colRef = getSamplesCollectionRef();
             if (!colRef) { showModal('錯誤', '資料庫服務尚未準備好。'); return; }
             try {
                 if (data.id) {
                     await updateDoc(doc(colRef, data.id), {
                         title: data.title, content: data.content, category: data.category, timestamp: serverTimestamp()
                     });
                     showModal('成功', '樣本已成功更新！', 'check-circle');
                 } else {
                     await addDoc(colRef, {
                         title: data.title || '無標題樣本', content: data.content || '', category: data.category || '未分類', timestamp: serverTimestamp()
                     });
                     showModal('成功', '新的文字樣本已建立！', 'plus-circle');
                 }
             } catch (error) { showModal('錯誤', `儲存失敗: ${error.message}`); }
        };

        const deleteSample = async (id) => {
            if (!id) return;
            const colRef = getSamplesCollectionRef();
            if (!colRef) return;
            try { await deleteDoc(doc(colRef, id)); showModal('刪除成功', '文字樣本已移除。', 'trash-2'); } 
            catch (error) { showModal('錯誤', `刪除失敗: ${error.message}`); }
        };

        // --- 5. UI 輔助與模態框邏輯 ---
        const hideModal = () => {
            const modal = document.getElementById('custom-modal');
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0', 'pointer-events-none');
        };

        const showModal = (title, message, icon = 'info') => {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            const iconHtml = `<i data-lucide="${icon}" class="lucide-icon text-indigo-600 w-6 h-6 mr-2"></i>`;
            document.getElementById('modal-icon-container').innerHTML = iconHtml;
            lucide.createIcons();
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100');
            setTimeout(() => hideModal(), 5000);
        };

        const handleDeleteClick = (id) => {
            const modal = document.getElementById('confirm-modal');
            document.getElementById('confirm-message').textContent = '您確定要永久刪除此文字樣本嗎？此操作無法撤銷。';
            document.getElementById('confirm-action-btn').onclick = () => { deleteSample(id); hideConfirmModal(); };
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100');
        };

        const hideConfirmModal = () => {
            const modal = document.getElementById('confirm-modal');
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0', 'pointer-events-none');
        };

        const showAddSampleModal = () => {
            updateNewSampleCategoryOptions();
            const modal = document.getElementById('add-sample-modal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100');
            document.getElementById('new-title').value = '';
            document.getElementById('new-content').value
