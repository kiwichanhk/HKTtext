<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文字樣本與作品集</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@100..900&display=swap');
        body { font-family: 'Noto Sans TC', 'Inter', sans-serif; background-color: #f7f7f9; }
        .sample-content { white-space: pre-wrap; }
        .custom-modal { transition: opacity 0.3s ease-in-out; }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-analytics.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBnQmqGZQ_94BDgmZFzOJsKDjgYq8ipI2I",
          authDomain: "hkttext.firebaseapp.com",
          projectId: "hkttext",
          storageBucket: "hkttext.firebasestorage.app",
          messagingSenderId: "501339425536",
          appId: "1:501339425536:web:f9ddbf080a002be99701e5",
          measurementId: "G-CKY8VPMJXJ"
        };

        let app, db, auth, userId = null;
        let samples = [];
        let currentCategoryFilter = '全部';
        let activeEditId = null;

        // 初始化 Firebase
        try {
            app = initializeApp(firebaseConfig);
            const analytics = getAnalytics(app);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (error) {
            console.error("Firebase Init Error:", error);
            document.body.innerHTML = `<div class="p-10 text-red-600">設定錯誤：${error.message}</div>`;
        }

        const appId = 'default-app-id';

        // 監聽登入狀態
        const signInAndListen = async () => {
            if (!auth) return;
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('auth-status').innerHTML = `<span class="text-sm text-green-600">已連接資料庫</span>`;
                    renderUI();
                    listenForSamples();
                } else {
                    signInAnonymously(auth).catch(e => console.error("Login failed", e));
                }
            });
        };

        // 資料庫監聽
        const getSamplesCollectionRef = () => userId ? collection(db, `artifacts/${appId}/users/${userId}/text_samples`) : null;

        const listenForSamples = () => {
            const col = getSamplesCollectionRef();
            if (!col) return;
            onSnapshot(query(col), (snapshot) => {
                samples = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                samples.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                renderUI();
            });
        };

        // UI 渲染邏輯
        const renderUI = () => {
            const container = document.getElementById('samples-container');
            if (!container) return;
            
            const filtered = currentCategoryFilter === '全部' ? samples : samples.filter(s => s.category === currentCategoryFilter);
            const categories = ['全部', ...new Set(samples.map(s => s.category))];
            
            // 渲染篩選器
            document.getElementById('filter-container').innerHTML = categories.map(c => 
                `<button onclick="window.app.setCategoryFilter('${c}')" class="px-3 py-1 rounded-full border ${currentCategoryFilter===c?'bg-blue-600 text-white':'bg-white'}">${c}</button>`
            ).join('');

            // 渲染列表
            if (filtered.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center py-10 text-gray-500">暫無資料</div>';
            } else {
                container.innerHTML = filtered.map(s => {
                    const isEdit = activeEditId === s.id;
                    return `
                    <div class="bg-white p-4 rounded shadow border-t-4 border-blue-500 flex flex-col">
                        <div class="flex justify-between mb-2">
                            ${isEdit ? `<input id="title-${s.id}" value="${s.title}" class="border p-1 w-full font-bold">` : `<h3 class="font-bold text-lg">${s.title}</h3>`}
                            <div class="ml-2 flex gap-2">
                                <button onclick="window.app.toggleEdit('${s.id}')" class="text-blue-500"><i data-lucide="${isEdit?'save':'edit'}"></i></button>
                                ${!isEdit ? `<button onclick="window.app.delete('${s.id}')" class="text-red-500"><i data-lucide="trash-2"></i></button>` : ''}
                            </div>
                        </div>
                        <div class="mb-2">
                             ${isEdit ? `<input id="cat-${s.id}" value="${s.category}" class="border p-1 text-xs">` : `<span class="text-xs bg-gray-200 px-2 py-1 rounded">${s.category}</span>`}
                        </div>
                        ${isEdit ? `<textarea id="content-${s.id}" class="border p-2 w-full h-32">${s.content}</textarea>` : `<div class="whitespace-pre-wrap text-gray-700 h-32 overflow-auto">${s.content}</div>`}
                    </div>`;
                }).join('');
            }
            lucide.createIcons();
        };

        // 功能綁定
        window.app = {
            setCategoryFilter: (c) => { currentCategoryFilter = c; renderUI(); },
            toggleEdit: (id) => {
                if (activeEditId === id) {
                    // Save
                    const title = document.getElementById(`title-${id}`).value;
                    const content = document.getElementById(`content-${id}`).value;
                    const category = document.getElementById(`cat-${id}`).value;
                    updateDoc(doc(getSamplesCollectionRef(), id), { title, content, category, timestamp: serverTimestamp() });
                    activeEditId = null;
                } else {
                    activeEditId = id;
                    renderUI();
                }
            },
            delete: (id) => { if(confirm('確定刪除?')) deleteDoc(doc(getSamplesCollectionRef(), id)); },
            create: () => {
                const title = document.getElementById('new-title').value;
                const content = document.getElementById('new-content').value;
                const category = document.getElementById('new-category').value || '未分類';
                if(!content) return alert('內容不能為空');
                addDoc(getSamplesCollectionRef(), { title, content, category, timestamp: serverTimestamp() })
                    .then(() => { 
                        document.getElementById('new-title').value = '';
                        document.getElementById('new-content').value = '';
                        document.getElementById('add-sample-modal').classList.add('hidden');
                    });
            },
            toggleModal: (show) => document.getElementById('add-sample-modal').classList.toggle('hidden', !show)
        };

        window.onload = () => {
            if(auth) signInAndListen();
            lucide.createIcons();
        };
    </script>
</head>
<body class="bg-gray-50 p-5">
    <div class="max-w-5xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">文字樣本與作品集</h1>
            <div id="auth-status" class="text-sm text-gray-400">連接中...</div>
        </div>

        <!-- 篩選器與新增按鈕 -->
        <div class="flex justify-between items-center mb-6">
            <div id="filter-container" class="flex gap-2 overflow-x-auto pb-2"></div>
            <button onclick="window.app.toggleModal(true)" class="bg-indigo-600 text-white px-4 py-2 rounded-full flex items-center shrink-0 ml-2">
                <i data-lucide="plus" class="w-4 h-4 mr-1"></i> 新增
            </button>
        </div>

        <!-- 內容列表 -->
        <div id="samples-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="col-span-full text-center py-10 text-gray-400">載入中...</div>
        </div>
    </div>

    <!-- 新增模態框 -->
    <div id="add-sample-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg w-full max-w-lg m-4">
            <h2 class="text-xl font-bold mb-4">新增樣本</h2>
            <input id="new-title" placeholder="標題" class="w-full border p-2 mb-3 rounded">
            <input id="new-category" placeholder="分類 (例如: 文案, 隨筆)" class="w-full border p-2 mb-3 rounded">
            <textarea id="new-content" placeholder="內容..." class="w-full border p-2 mb-4 h-32 rounded"></textarea>
            <div class="flex justify-end gap-2">
                <button onclick="window.app.toggleModal(false)" class="px-4 py-2 bg-gray-200 rounded">取消</button>
                <button onclick="window.app.create()" class="px-4 py-2 bg-indigo-600 text-white rounded">儲存</button>
            </div>
        </div>
    </div>
</body>
</html>
