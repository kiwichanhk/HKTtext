<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文字樣本與作品集 (AI 增強版)</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 Lucide Icons (用於美觀圖標) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@100..900&display=swap');
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        .sample-content {
            white-space: pre-wrap; /* 保留換行和空格 */
        }
        /* Custom modal for alerts/prompts */
        .custom-modal {
            transition: opacity 0.3s ease-in-out;
        }
        .lucide {
            width: 1.25rem;
            height: 1.25rem;
        }
        /* 模態框動畫 */
        .modal-content-transition {
            transition: transform 0.3s ease-out;
        }
    </style>
    <!-- Firebase & Gemini API Imports and Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Firestore uses logging to console.
        setLogLevel('Debug');
        
        // --- 1. 全域變數、設定檔與初始化 ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // --- IMPORTANT: 使用者自定義 Firebase 設定 (若在 GitHub 或本地環境運行) ---
        const customFirebaseConfig = {
            apiKey: "AIzaSyBnQmqGZQ_94BDgmZFzOJsKDjgYq8ipI2I",
            authDomain: "hkttext.firebaseapp.com",
            projectId: "hkttext",
            storageBucket: "hkttext.firebasestorage.app",
            messagingSenderId: "501339425536",
            appId: "1:501339425536:web:f9ddbf080a002be99701e5",
            measurementId: "G-CKY8VPMJXJ" 
        };

        const envFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const isCustomConfigReady = customFirebaseConfig.projectId !== "YOUR_PROJECT_ID" && customFirebaseConfig.projectId !== undefined;

        const firebaseConfig = envFirebaseConfig || (isCustomConfigReady ? customFirebaseConfig : null);
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;
        let samples = [];
        let currentCategoryFilter = '全部';
        let activeEditId = null;

        if (firebaseConfig) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } else {
            console.error("Firebase configuration is missing. Data persistence will not work.");
            document.getElementById('app-container').innerHTML = `
                <div class="p-6 bg-red-100 border border-red-400 text-red-700 rounded-lg max-w-lg mx-auto mt-10">
                    <p class="font-bold">設定錯誤</p>
                    <p>無法載入 Firebase 配置。請檢查環境變數，或將您的專案配置貼入 \`customFirebaseConfig\` 變數內。</p>
                </div>
            `;
        }
        
        // --- 2. Gemini API 邏輯與工具函式 ---
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
        const GEMINI_API_KEY = ""; // Canvas will provide this if empty
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;

        // 輔助函式：指數退避 (Exponential Backoff)
        const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

        const fetchWithBackoff = async (url, options, retries = 3) => {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        if (response.status === 429 || response.status >= 500) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const errorBody = await response.text();
                        throw new Error(`API Error: ${response.status} - ${errorBody}`);
                    }
                    return response.json();
                } catch (error) {
                    if (i === retries - 1) {
                        console.error("Max retries reached. Failing request.", error);
                        throw error;
                    }
                    const backoffTime = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    console.warn(`Attempt ${i + 1} failed. Retrying in ${backoffTime / 1000}s...`);
                    await delay(backoffTime);
                }
            }
        };

        // 呼叫 Gemini API 的主要函式
        const callGemini = async (userPrompt, systemPrompt) => {
            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            const result = await fetchWithBackoff(GEMINI_API_URL, options);
            
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!text) {
                throw new Error("Gemini response was empty or malformed.");
            }
            return text;
        };
        
        // --- 3. 認證與使用者設定 (與原程式碼相同，略過註釋) ---
        const signInAndListen = async () => {
            if (!auth) {
                console.error("Authentication service not initialized. Skipping sign-in.");
                return;
            }
            
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Authentication failed:", error);
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('auth-status').innerHTML = `
                        <span class="hidden" id="actual-user-id">${userId}</span>
                        <span class="text-sm text-gray-500 flex items-center" title="已連接 Firebase 資料庫">
                            <i data-lucide="database" class="lucide-icon w-4 h-4 mr-1 text-indigo-500"></i>
                            已連接資料庫
                        </span>
                    `;
                    lucide.createIcons();
                    if (db) {
                        listenForSamples();
                    }
                } else {
                    console.log("User signed out or failed to sign in.");
                }
            });
        };
        
        // --- 4. Firestore 資料操作 (與原程式碼相同，略過註釋) ---

        const getSamplesCollectionRef = () => {
            if (!userId || !db) {
                console.error("User ID or Firestore service is not set. Cannot get collection reference.");
                return null;
            }
            return collection(db, `artifacts/${appId}/users/${userId}/text_samples`);
        };

        const listenForSamples = () => {
            const colRef = getSamplesCollectionRef();
            if (!colRef) return;

            const q = query(colRef);
            
            onSnapshot(q, (snapshot) => {
                samples = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                samples.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                
                renderUI();
            }, (error) => {
                console.error("Error listening to Firestore:", error);
                showModal('錯誤', '無法連接到資料庫，請檢查您的網路連線。');
            });
        };

        const saveSample = async (data) => {
            const colRef = getSamplesCollectionRef();
            if (!colRef) return;

            try {
                if (data.id) {
                    const docRef = doc(colRef, data.id);
                    await updateDoc(docRef, {
                        title: data.title,
                        content: data.content,
                        category: data.category,
                        timestamp: serverTimestamp()
                    });
                    showModal('成功', '樣本已成功更新！', 'check-circle');
                } else {
                    await addDoc(colRef, {
                        title: data.title || '無標題樣本',
                        content: data.content || '',
                        category: data.category || '未分類',
                        timestamp: serverTimestamp()
                    });
                    showModal('成功', '新的文字樣本已建立！', 'plus-circle');
                }
            } catch (error) {
                console.error("Error saving sample:", error);
                showModal('錯誤', `儲存失敗: ${error.message}`);
            }
        };

        const deleteSample = async (id) => {
            if (!id) return;
            const colRef = getSamplesCollectionRef();
            if (!colRef) return;

            try {
                const docRef = doc(colRef, id);
                await deleteDoc(docRef);
                showModal('刪除成功', '文字樣本已移除。', 'trash-2');
            } catch (error) {
                console.error("Error deleting sample:", error);
                showModal('錯誤', `刪除失敗: ${error.message}`);
            }
        };
        
        // --- 5. UI 輔助與模態框邏輯 ---

        // 隱藏模態框
        const hideModal = () => {
            const modal = document.getElementById('custom-modal');
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0', 'pointer-events-none');
        };

        // 顯示自定義模態框 (用於代替 alert/confirm)
        const showModal = (title, message, icon = 'info') => {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            
            const iconHtml = `<i data-lucide="${icon}" class="lucide-icon text-indigo-600 w-6 h-6 mr-2"></i>`;
            document.getElementById('modal-icon-container').innerHTML = iconHtml;
            lucide.createIcons();

            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100');

            // 5秒後自動關閉
            setTimeout(() => {
                hideModal();
            }, 5000);
        };
        
        // 處理刪除確認 (與原程式碼相同，略過註釋)
        const handleDeleteClick = (id) => {
            const modal = document.getElementById('confirm-modal');
            
            document.getElementById('confirm-message').textContent = '您確定要永久刪除此文字樣本嗎？此操作無法撤銷。';
            
            const confirmBtn = document.getElementById('confirm-action-btn');
            confirmBtn.onclick = () => {
                deleteSample(id);
                hideConfirmModal();
            };

            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100');
        };

        const hideConfirmModal = () => {
            const modal = document.getElementById('confirm-modal');
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0', 'pointer-events-none');
        };

        const showAddSampleModal = () => {
            updateNewSampleCategoryOptions();
            const modal = document.getElementById('add-sample-modal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100');
            
            document.getElementById('new-title').value = '';
            document.getElementById('new-content').value = '';
            document.getElementById('new-category').value = '未分類';
            document.getElementById('draft-prompt').value = ''; // Clear prompt
            lucide.createIcons();
        };

        const hideAddSampleModal = () => {
            const modal = document.getElementById('add-sample-modal');
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0', 'pointer-events-none');
        };
        
        const showAddCategoryModal = () => {
            const modal = document.getElementById('add-category-modal');
            document.getElementById('new-category-name').value = '';
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100');
            lucide.createIcons();
        };

        const hideAddCategoryModal = () => {
            const modal = document.getElementById('add-category-modal');
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0', 'pointer-events-none');
        };

        const addNewCategoryAndFilter = async () => {
            const categoryNameInput = document.getElementById('new-category-name');
            const newCategoryName = categoryNameInput.value.trim();

            if (!newCategoryName) {
                showModal('錯誤', '分類名稱不能為空。', 'alert-octagon');
                return;
            }
            
            const existingCategories = getCategories().filter(c => c !== '全部');
            if (existingCategories.includes(newCategoryName)) {
                showModal('注意', `分類 "${newCategoryName}" 已經存在。已為您切換至該篩選器。`, 'alert-triangle');
                setCategoryFilter(newCategoryName);
                hideAddCategoryModal();
                return;
            }

            const placeholderSample = {
                title: `新分類預留項目: ${newCategoryName}`,
                content: `這是為新分類「${newCategoryName}」建立的預留樣本。請編輯或刪除此項目。`,
                category: newCategoryName
            };

            try {
                await saveSample(placeholderSample);
                setCategoryFilter(newCategoryName);
                hideAddCategoryModal();
                showModal('分類新增成功', `已建立新分類「${newCategoryName}」並切換篩選。`, 'folder-check');
            } catch (error) {
                showModal('錯誤', `無法新增分類: ${error.message}`, 'alert-octagon');
            }
        };

        const toggleEditMode = (id) => {
            const sampleCard = document.getElementById(`sample-${id}`);
            if (!sampleCard) return;

            const isCurrentlyEditing = activeEditId === id;

            if (isCurrentlyEditing) {
                const titleInput = sampleCard.querySelector('#edit-title');
                const contentInput = sampleCard.querySelector('#edit-content');
                const categorySelect = sampleCard.querySelector('#edit-category');
                
                const updatedSample = {
                    id: id,
                    title: titleInput.value,
                    content: contentInput.value,
                    category: categorySelect.value
                };
                
                saveSample(updatedSample);
                activeEditId = null;

            } else {
                if (activeEditId) {
                    activeEditId = null;
                    renderUI(); 
                }
                activeEditId = id;
            }
            renderUI();
        };

        const setCategoryFilter = (category) => {
            currentCategoryFilter = category;
            renderUI();
        };

        const getCategories = () => {
            const categorySet = new Set(samples.map(s => s.category).filter(c => c));
            return ['全部', ...Array.from(categorySet)].sort();
        };
        
        const updateNewSampleCategoryOptions = () => {
            const categories = getCategories();
            const categorySelect = document.getElementById('new-category');
            if (!categorySelect) return;

            const categoryOptions = categories.filter(c => c !== '全部').map(cat => 
                `<option value="${cat}">${cat}</option>`
            ).join('');

            categorySelect.innerHTML = `
                <option value="未分類">未分類</option>
                ${categoryOptions}
                <option value="新增分類">--- 請使用篩選器區域按鈕 ---</option>
            `;
        };
        
        // --- 6. 新增：處理中/翻譯模態框 ---
        const showProcessingModal = (title, message) => {
            const modal = document.getElementById('processing-modal');
            document.getElementById('processing-title').textContent = title;
            document.getElementById('processing-message').textContent = message;
            
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100');
            lucide.createIcons();
        };

        const hideProcessingModal = () => {
            const modal = document.getElementById('processing-modal');
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0', 'pointer-events-none');
        };

        // **************** 已修改：替換為翻譯結果模態框 ****************
        const showTranslationModal = (id, translation, originalContent) => {
            const modal = document.getElementById('translation-modal');
            document.getElementById('translation-content-display').innerHTML = translation.replace(/\n/g, '<br>');
            
            const replaceBtn = document.getElementById('translation-replace-btn');
            replaceBtn.onclick = () => {
                // 找到原始樣本物件
                const sampleToUpdate = samples.find(s => s.id === id);
                if (sampleToUpdate) {
                    // 執行更新
                    const updatedSample = {
                        id: id,
                        title: sampleToUpdate.title,
                        content: translation.trim(), // 用翻譯內容替換內容
                        category: sampleToUpdate.category
                    };
                    saveSample(updatedSample);
                }
                hideTranslationModal();
            };

            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100');
            lucide.createIcons();
        };

        const hideTranslationModal = () => {
            const modal = document.getElementById('translation-modal');
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0', 'pointer-events-none');
        };

        // --- 7. 新增：Gemini 翻譯功能 (替換總結) ---
        const translateSample = async (id, originalContent) => {
            if (!originalContent.trim().length) {
                 showModal('注意', '樣本內容為空，無法翻譯。', 'alert-triangle');
                 return;
            }

            showProcessingModal('正在翻譯', 'Gemini 正在將您的文本翻譯成英文...');
            
            try {
                const systemPrompt = "你是一位專業的翻譯家。請將使用者提供的文本精準、流暢地翻譯成專業的**英文**。僅返回翻譯後的文本內容，不要包含任何額外的說明或註釋。";
                const translation = await callGemini(originalContent, systemPrompt);
                
                hideProcessingModal();
                showTranslationModal(id, translation, originalContent);
                
            } catch (error) {
                hideProcessingModal();
                console.error("Translation failed:", error);
                showModal('翻譯錯誤', `無法生成翻譯：${error.message}`, 'alert-octagon');
            }
        };
        
        // --- 8. 新增：Gemini 草稿生成功能 ---
        const generateDraft = async () => {
            const draftPrompt = document.getElementById('draft-prompt').value.trim();
            const contentTextarea = document.getElementById('new-content');

            if (!draftPrompt) {
                showModal('提示', '請輸入您的草稿需求描述！', 'alert-triangle');
                return;
            }
            
            showProcessingModal('正在生成草稿', 'Gemini 正在根據您的需求寫作...');
            
            try {
                const systemPrompt = "你是一位頂尖的文案設計師。請根據使用者的要求，以繁體中文寫作一篇專業的文本草稿。僅返回文本內容，不要包含任何開頭或結尾的註釋。";
                const generatedContent = await callGemini(draftPrompt, systemPrompt);
                
                // 成功後將生成的內容填入 textarea
                contentTextarea.value = generatedContent.trim();
                // 使用提示作為標題前綴
                document.getElementById('new-title').value = `AI 草稿: ${draftPrompt.substring(0, 30)}${draftPrompt.length > 30 ? '...' : ''}`;
                
                hideProcessingModal();
                showModal('生成成功', '草稿已成功填入內容欄位，請檢查和修改。', 'check-circle');
                
            } catch (error) {
                hideProcessingModal();
                console.error("Draft generation failed:", error);
                showModal('生成錯誤', `無法生成草稿：${error.message}`, 'alert-octagon');
            }
        };


        // --- 9. 主渲染函式：修復首段落空位並新增按鈕 ---
        const renderSampleCard = (sample) => {
            const date = sample.timestamp ? new Date(sample.timestamp.seconds * 1000).toLocaleString('zh-TW', {
                year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit'
            }) : '尚未儲存';

            const categories = getCategories();
            const categoryOptions = categories.filter(c => c !== '全部').map(cat => 
                `<option value="${cat}" ${sample.category === cat ? 'selected' : ''}>${cat}</option>`
            ).join('');
            if (!categories.includes(sample.category) && sample.category) {
                 categoryOptions.unshift(`<option value="${sample.category}" selected>${sample.category}</option>`);
            }
            
            const editCategorySelect = `
                <select id="edit-category" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                    ${categoryOptions}
                    <option value="未分類" ${sample.category === '未分類' ? 'selected' : ''}>未分類</option>
                </select>
            `;

            const isEditing = activeEditId === sample.id;

            // 用 JSON.stringify 包裝 sample.content 並使用反引號模板，確保內容能正確傳遞給 translateSample 函式
            const escapedContent = JSON.stringify(sample.content).slice(1, -1).replace(/\\/g, '\\\\').replace(/'/g, '\\\'');

            // 修正：使用 .trim() 移除首尾空白和空行，解決首段落空位問題
            const displayContent = sample.content.trim().replace(/\n/g, '<br>');

            return `
                <div id="sample-${sample.id}" class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition duration-300 flex flex-col h-full border-t-4 border-indigo-500">
                    <div class="flex justify-between items-start mb-4">
                        ${isEditing ? `
                            <input id="edit-title" value="${sample.title}" class="text-xl font-bold text-gray-800 w-full border-b border-gray-300 p-1 mb-2 focus:outline-none focus:border-indigo-500">
                        ` : `
                            <h3 class="text-xl font-bold text-gray-800">${sample.title}</h3>
                        `}
                        <div class="flex-shrink-0 ml-4 flex space-x-2">
                            ${isEditing ? '' : `
                                <!-- 已修改：AI 翻譯按鈕 (替換了總結) -->
                                <button onclick="window.app.translateSample('${sample.id}', '${escapedContent}')" class="text-white bg-blue-500 hover:bg-blue-600 p-2 rounded-full shadow-md transition duration-150" title="使用 Gemini 翻譯為英文">
                                    <i data-lucide="languages" class="lucide-icon w-4 h-4"></i>
                                </button>
                            `}
                            <button onclick="window.app.toggleEditMode('${sample.id}')" class="text-white ${isEditing ? 'bg-green-500 hover:bg-green-600' : 'bg-indigo-500 hover:bg-indigo-600'} p-2 rounded-full shadow-md transition duration-150">
                                <i data-lucide="${isEditing ? 'save' : 'edit'}" class="lucide-icon w-4 h-4"></i>
                            </button>
                            ${isEditing ? '' : `
                                <button onclick="window.app.handleDeleteClick('${sample.id}')" class="text-white bg-red-500 hover:bg-red-600 p-2 rounded-full shadow-md transition duration-150">
                                    <i data-lucide="trash-2" class="lucide-icon w-4 h-4"></i>
                                </button>
                            `}
                        </div>
                    </div>

                    <div class="mb-4 text-sm font-medium text-indigo-600 flex items-center">
                        <i data-lucide="tag" class="lucide-icon w-4 h-4 mr-1"></i>
                        ${isEditing ? editCategorySelect : `
                            <span class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-semibold">${sample.category}</span>
                        `}
                    </div>
                    
                    ${isEditing ? `
                        <textarea id="edit-content" class="flex-grow w-full h-48 border border-gray-300 p-3 rounded-lg resize-y focus:ring-indigo-500 focus:border-indigo-500 text-gray-700">${sample.content}</textarea>
                    ` : `
                        <div class="flex-grow text-gray-700 sample-content overflow-auto mb-4 border p-3 rounded-lg bg-gray-50 max-h-64">
                            ${displayContent}
                        </div>
                    `}

                    <p class="text-xs text-gray-500 mt-auto pt-2 border-t border-gray-100">
                        最後編輯於: ${date}
                    </p>
                </div>
            `;
        };
        
        const createNewSample = () => {
            const titleInput = document.getElementById('new-title');
            const contentInput = document.getElementById('new-content');
            const categorySelect = document.getElementById('new-category');
            
            let category = categorySelect.value;
            
            if (category === '新增分類') {
                showModal('注意', '請在上方「篩選器」區域使用「新增分類」按鈕來建立新分類，或選擇一個現有的分類。', 'alert-triangle');
                return; 
            }
            
            const newSample = {
                title: titleInput.value || '無標題樣本',
                content: contentInput.value || '',
                category: category
            };

            if (!newSample.content.trim()) {
                showModal('注意', '內容不能為空！', 'alert-triangle');
                return;
            }

            saveSample(newSample).then(() => {
                titleInput.value = '';
                contentInput.value = '';
                categorySelect.value = '未分類';
                document.getElementById('draft-prompt').value = ''; // Clear prompt
                hideAddSampleModal();
            });
        };

        const renderUI = () => {
            const samplesContainer = document.getElementById('samples-container');
            const filterContainer = document.getElementById('filter-container');
            
            const categories = getCategories();
            const filteredSamples = currentCategoryFilter === '全部'
                ? samples
                : samples.filter(s => s.category === currentCategoryFilter);

            filterContainer.innerHTML = categories.map(cat => `
                <button 
                    onclick="window.app.setCategoryFilter('${cat}')"
                    class="px-4 py-2 text-sm font-semibold rounded-full transition duration-150 ${currentCategoryFilter === cat 
                        ? 'bg-indigo-600 text-white shadow-lg' 
                        : 'bg-white text-gray-700 hover:bg-indigo-100 border border-gray-300'}"
                >
                    ${cat} (${cat === '全部' ? samples.length : samples.filter(s => s.category === cat).length})
                </button>
            `).join('') + `
                <button 
                    onclick="window.app.showAddCategoryModal()"
                    class="px-4 py-2 text-sm font-semibold rounded-full transition duration-150 bg-indigo-50 border border-indigo-300 text-indigo-700 hover:bg-indigo-200 flex items-center"
                >
                    <i data-lucide="plus" class="lucide-icon w-4 h-4 mr-1"></i>
                    新增分類
                </button>
            `;

            if (filteredSamples.length === 0) {
                samplesContainer.innerHTML = `
                    <div class="col-span-full text-center py-10 bg-white rounded-xl shadow-inner text-gray-500">
                        <i data-lucide="book-open" class="lucide-icon w-12 h-12 mx-auto mb-4 text-gray-300"></i>
                        <p class="text-lg">目前在這個分類中沒有文字樣本。</p>
                        <p class="text-sm">點擊右上角的「新增文字樣本」按鈕開始創建吧！</p>
                    </div>
                `;
            } else {
                samplesContainer.innerHTML = filteredSamples.map(renderSampleCard).join('');
            }
            
            lucide.createIcons();
        };

        // --- 10. 啟動應用程式 ---
        window.app = {
            setCategoryFilter,
            toggleEditMode,
            createNewSample,
            handleDeleteClick,
            hideConfirmModal,
            showAddSampleModal,
            hideAddSampleModal,
            showAddCategoryModal,
            hideAddCategoryModal,
            addNewCategoryAndFilter,
            hideModal, 
            saveSample,
            renderUI,
            // 新增 Gemini 函式 (已更新為翻譯)
            translateSample, // 替換 summarizeSample
            generateDraft,
            hideTranslationModal, // 替換 hideSummaryModal
        };
        
        window.onload = () => {
            if (auth && db) {
                signInAndListen();
            } else {
                console.warn("Firebase not initialized, skipping authentication.");
            }
        };

    </script>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- 處理中模態框 (Processing Modal) -->
    <div id="processing-modal" class="custom-modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-xs w-full transform transition-all duration-300 scale-100 flex items-center justify-center" onclick="event.stopPropagation()">
            <i data-lucide="loader" class="lucide-icon w-6 h-6 mr-3 text-indigo-500 animate-spin"></i>
            <div>
                <h3 id="processing-title" class="text-lg font-bold text-gray-800">處理中</h3>
                <p id="processing-message" class="text-sm text-gray-600">請稍候...</p>
            </div>
        </div>
    </div>
    
    <!-- **************** 已修改：AI 翻譯結果模態框 (Translation Modal) **************** -->
    <div id="translation-modal" class="custom-modal fixed inset-0 z-40 flex items-center justify-center bg-black bg-opacity-70 opacity-0 pointer-events-none" onclick="window.app.hideTranslationModal()">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-3xl w-full transform transition-all duration-300 modal-content-transition scale-90" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h2 class="text-2xl font-extrabold text-blue-800 flex items-center">
                    <i data-lucide="languages" class="lucide-icon w-6 h-6 mr-2"></i>
                    AI 翻譯結果 (英文)
                </h2>
                <button onclick="window.app.hideTranslationModal()" class="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100">
                    <i data-lucide="x" class="lucide-icon w-6 h-6"></i>
                </button>
            </div>
            
            <p class="text-sm font-semibold text-gray-700 mb-2">Gemini 翻譯後的英文內容：</p>
            <div id="translation-content-display" class="bg-blue-50 border border-blue-200 p-4 rounded-lg text-gray-700 sample-content max-h-64 overflow-auto mb-6">
                <!-- Translation content inserted here by JS -->
            </div>
            
            <div class="flex justify-end space-x-3">
                <button onclick="window.app.hideTranslationModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 transition duration-150">取消</button>
                <button id="translation-replace-btn" class="px-6 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition duration-150 flex items-center">
                    <i data-lucide="file-check" class="lucide-icon w-4 h-4 mr-2"></i>
                    用翻譯替換原內容
                </button>
            </div>
        </div>
    </div>
    <!-- ********************************************************************************* -->


    <!-- 自定義訊息模態框 (Custom Modal) -->
    <div id="custom-modal" class="custom-modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-95" onclick="event.stopPropagation()">
            <div class="flex items-center mb-4">
                <span id="modal-icon-container"></span>
                <h3 id="modal-title" class="text-lg font-bold text-gray-800">訊息</h3>
                <button onclick="window.app.hideModal()" class="ml-auto text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="lucide-icon w-5 h-5"></i>
                </button>
            </div>
            <p id="modal-message" class="text-gray-600 mb-4"></p>
            <div class="flex justify-end">
                <button onclick="window.app.hideModal()" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition duration-150">確定</button>
            </div>
        </div>
    </div>
    
    <!-- 確認刪除模態框 (Confirm Modal) -->
    <div id="confirm-modal" class="custom-modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-95" onclick="event.stopPropagation()">
            <div class="flex items-center mb-4">
                <i data-lucide="alert-triangle" class="lucide-icon text-red-500 w-6 h-6 mr-2"></i>
                <h3 class="text-lg font-bold text-gray-800">確認操作</h3>
            </div>
            <p id="confirm-message" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button onclick="window.app.hideConfirmModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150">取消</button>
                <button id="confirm-action-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150">確認刪除</button>
            </div>
        </div>
    </div>
    
    <!-- 新增樣本模態框 (Add Sample Modal) -->
    <div id="add-sample-modal" class="custom-modal fixed inset-0 z-40 flex items-center justify-center bg-black bg-opacity-70 opacity-0 pointer-events-none" onclick="window.app.hideAddSampleModal()">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-4xl w-full transform transition-all duration-300 modal-content-transition scale-90" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h2 class="text-2xl font-extrabold text-indigo-800 flex items-center">
                    <i data-lucide="plus-square" class="lucide-icon w-6 h-6 mr-2"></i>
                    新增文字樣本
                </h2>
                <button onclick="window.app.hideAddSampleModal()" class="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100">
                    <i data-lucide="x" class="lucide-icon w-6 h-6"></i>
                </button>
            </div>
            
            <div class="bg-white" id="add-new-sample-form">
                
                <!-- 新增：AI 草稿生成區塊 -->
                <div class="mb-6 p-4 border border-blue-200 bg-blue-50 rounded-lg shadow-inner">
                    <h3 class="text-lg font-bold text-blue-700 flex items-center mb-2">
                        <i data-lucide="sparkles" class="lucide-icon w-5 h-5 mr-2"></i>
                        AI 智能草稿生成
                    </h3>
                    <p class="text-sm text-gray-600 mb-2">請輸入您想要 AI 撰寫的內容描述：</p>
                    <div class="flex space-x-3">
                        <input type="text" id="draft-prompt" class="flex-grow rounded-md border-gray-300 shadow-sm p-3 focus:border-blue-500 focus:ring-blue-500" placeholder="例如：一篇介紹 App 新功能的銷售文案">
                        <button onclick="window.app.generateDraft()" class="flex-shrink-0 inline-flex items-center px-4 py-3 border border-transparent text-sm font-medium rounded-full shadow-md text-white bg-blue-600 hover:bg-blue-700 transition duration-150">
                            <i data-lucide="pen-tool" class="lucide-icon w-5 h-5 mr-1"></i>
                            生成草稿
                        </button>
                    </div>
                </div>

                <!-- 傳統手動輸入區塊 -->
                <p class="text-sm text-gray-700 mb-4">或手動填寫以下欄位：</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="md:col-span-2">
                        <label for="new-title" class="block text-sm font-medium text-gray-700">標題</label>
                        <input type="text" id="new-title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="輸入樣本標題">
                    </div>
                    <div>
                        <label for="new-category" class="block text-sm font-medium text-gray-700">分類</label>
                        <select id="new-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500">
                            <option value="未分類">未分類</option>
                            <option value="新增分類">--- 請使用篩選器區域按鈕 ---</option>
                        </select>
                    </div>
                </div>
                <label for="new-content" class="block text-sm font-medium text-gray-700 mb-1">內容</label>
                <textarea id="new-content" rows="10" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="在此輸入您的文字內容..."></textarea>
                
                <button onclick="window.app.createNewSample()" class="mt-4 w-full md:w-auto inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-full shadow-lg text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                    <i data-lucide="send" class="lucide-icon w-5 h-5 mr-2"></i>
                    儲存樣本
                </button>
            </div>
        </div>
    </div>
    
    <!-- 新增分類模態框 (Add Category Modal) -->
    <div id="add-category-modal" class="custom-modal fixed inset-0 z-40 flex items-center justify-center bg-black bg-opacity-70 opacity-0 pointer-events-none" onclick="window.app.hideAddCategoryModal()">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-md w-full transform transition-all duration-300 modal-content-transition scale-90" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h2 class="text-xl font-extrabold text-indigo-800 flex items-center">
                    <i data-lucide="folder-plus" class="lucide-icon w-5 h-5 mr-2"></i>
                    新增篩選分類
                </h2>
                <button onclick="window.app.hideAddCategoryModal()" class="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100">
                    <i data-lucide="x" class="lucide-icon w-6 h-6"></i>
                </button>
            </div>
            <label for="new-category-name" class="block text-sm font-medium text-gray-700 mb-1">分類名稱</label>
            <input type="text" id="new-category-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="例如：部落格文章, 產品描述">
            
            <button onclick="window.app.addNewCategoryAndFilter()" class="mt-4 w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-full shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                <i data-lucide="check" class="lucide-icon w-4 h-4 mr-2"></i>
                新增並篩選
            </button>
        </div>
    </div>


    <!-- 主要內容區塊 -->
    <div id="app-container" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">

        <!-- Header and Action Bar -->
        <header class="mb-8 p-4 bg-white rounded-xl shadow-md flex justify-between items-start flex-wrap gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-gray-900 flex items-center">
                    <i data-lucide="feather" class="lucide-icon text-indigo-500 w-8 h-8 mr-3"></i>
                    我的文字樣本庫 (AI 增強)
                </h1>
                <p class="text-gray-500 mt-1">在這裡管理和修改您的文字作品集。</p>
                <div id="auth-status" class="mt-2">
                    <span class="text-sm text-gray-500">正在連接...</span>
                </div>
            </div>
            
            <!-- 新增樣本按鈕 (移到右上角) -->
            <div id="header-actions" class="text-right flex-shrink-0">
                <button onclick="window.app.showAddSampleModal()" class="inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-full shadow-lg text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150">
                    <i data-lucide="plus" class="lucide-icon w-5 h-5 mr-2"></i>
                    新增文字樣本
                </button>
            </div>
        </header>
        
        <!-- 篩選器 -->
        <div class="mb-6 p-4 bg-white rounded-xl shadow-md">
            <h2 class="text-xl font-semibold text-gray-700 mb-3 flex items-center">
                <i data-lucide="filter" class="lucide-icon w-5 h-5 mr-2 text-indigo-500"></i>
                分類篩選
            </h2>
            <div id="filter-container" class="flex flex-wrap gap-2">
                <button class="px-4 py-2 text-sm font-semibold rounded-full bg-indigo-600 text-white shadow-lg">全部 (0)</button>
            </div>
        </div>

        <!-- 樣本列表 -->
        <div id="samples-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="col-span-full text-center py-10 text-gray-400">
                <i data-lucide="loader" class="lucide-icon w-8 h-8 mx-auto mb-2 animate-spin"></i>
                <p>正在載入您的作品...</p>
            </div>
        </div>

        <!-- Footer for padding -->
        <div class="h-10"></div>
    </div>

</body>
</html>
