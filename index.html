<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡å­—æ¨£æœ¬èˆ‡ä½œå“é›†</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Lucide Icons (ç”¨æ–¼ç¾è§€åœ–æ¨™) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@100..900&display=swap');
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        .sample-content {
            white-space: pre-wrap; /* ä¿ç•™æ›è¡Œå’Œç©ºæ ¼ */
        }
        /* Custom modal for alerts/prompts */
        .custom-modal {
            transition: opacity 0.3s ease-in-out;
        }
        .lucide {
            width: 1.25rem;
            height: 1.25rem;
        }
        /* æ¨¡æ…‹æ¡†å‹•ç•« */
        .modal-content-transition {
            transition: transform 0.3s ease-out;
        }
    </style>
    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-analytics.js";

        
        // --- 1. è¨­å®šæª”èˆ‡åˆå§‹åŒ– ---
        const firebaseConfig = {
          apiKey: "AIzaSyBnQmqGZQ_94BDgmZFzOJsKDjgYq8ipI2I",
          authDomain: "hkttext.firebaseapp.com",
          projectId: "hkttext",
          storageBucket: "hkttext.firebasestorage.app",
          messagingSenderId: "501339425536",
          appId: "1:501339425536:web:f9ddbf080a002be99701e5",
          measurementId: "G-CKY8VPMJXJ"
        };

        let app, db, auth, analytics, userId = null;
        let originalAuthUid = null; // ä¿å­˜åŸå§‹ Firebase auth.uid

        // ğŸ”— å¾ URL è®€å– userId åƒæ•¸
        const urlParams = new URLSearchParams(window.location.search);
        const sharedUserId = urlParams.get('userId');

        // ğŸ†” è‡ªè¨‚ userId ç®¡ç†
        const getCustomUserId = () => {
            return localStorage.getItem('customUserId');
        };

        const setCustomUserId = (customId) => {
            if (customId && customId.trim()) {
                localStorage.setItem('customUserId', customId.trim());
                return true;
            }
            return false;
        };

        const getOriginalAuthUid = () => {
            return localStorage.getItem('originalAuthUid');
        };

        const setOriginalAuthUid = (uid) => {
            if (!getOriginalAuthUid()) {
                localStorage.setItem('originalAuthUid', uid);
            }
        };
        let samples = [];
        let profiles = JSON.parse(localStorage.getItem('hkt_profiles')) || ['æ‰€æœ‰æ–‡æœ¬'];
        let currentProfileName = localStorage.getItem('hkt_current_profile') || 'æ‰€æœ‰æ–‡æœ¬';
        let currentCategoryFilter = 'å…¨éƒ¨';
        let currentUserFilter = '';
        let searchTerm = '';
        let activeEditId = null;
        const appId = 'default-app-id'; // éœ€è¦ä¿ç•™æ­¤è®Šæ•¸ä¾›ä¸‹æ–¹ä½¿ç”¨

        // åˆå§‹åŒ– Firebase
        try {
            app = initializeApp(firebaseConfig);
            analytics = getAnalytics(app);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase init error:", error);
            alert("Firebase åˆå§‹åŒ–å¤±æ•—: " + error.message);
        }

        
        // --- 3. èªè­‰èˆ‡ä½¿ç”¨è€…è¨­å®š (é—œéµä¿®æ”¹) ---
        
        
        const renderUserTabs = () => {
            const container = document.getElementById('user-tabs-container');
            if (!container) return;

            let html = profiles.map(p => {
                const isActive = p === currentProfileName;
                const isDeletable = p !== 'æ‰€æœ‰æ–‡æœ¬';

                return `
                <div style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.375rem 0.75rem; border-radius: 0.5rem; background: ${isActive ? '#4f46e5' : '#ffffff'}; color: ${isActive ? '#ffffff' : '#374151'}; border: 1px solid ${isActive ? '#4f46e5' : '#d1d5db'}; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                    <button 
                        onclick="window.app.switchProfile('${p}')"
                        style="background: none; border: none; cursor: pointer; font-weight: 600; font-size: 0.875rem; color: inherit; padding: 0;"
                    >
                        ${p}
                    </button>
                    ${isDeletable ? `
                        <button 
                            onclick="event.stopPropagation(); window.app.deleteProfile('${p}')" 
                            style="background: none; border: none; cursor: pointer; padding: 0.25rem; margin-left: 0.25rem; color: ${isActive ? '#ffffff' : '#9ca3af'};"
                            title="åˆªé™¤ç”¨æˆ¶"
                        >
                            âœ•
                        </button>
                    ` : ''}
                </div>
                `;
            }).join('');

            html += `
                <button 
                    onclick="window.app.addProfile()" 
                    style="padding: 0.375rem 0.75rem; border-radius: 0.5rem; border: 2px dashed #d1d5db; background: transparent; color: #6b7280; cursor: pointer; font-weight: 600; font-size: 0.875rem;"
                >
                    + æ–°å¢
                </button>
            `;

            container.innerHTML = html;
        };

        const setupSearchListener = () => {
            const input = document.getElementById('search-input');
            if (input) {
                input.addEventListener('input', (e) => {
                    searchTerm = e.target.value;
                    renderUI();
                });
            }
        };

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', renderUserTabs);
        } else {
            renderUserTabs();
        }

const signInAndListen = async () => {
            if (!auth) return;
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // ä¿å­˜åŸå§‹ auth.uidï¼ˆé¦–æ¬¡è¨ªå•æ™‚ï¼‰
                    originalAuthUid = user.uid;
                    setOriginalAuthUid(user.uid);

                    // å„ªå…ˆé †åºï¼šURL åƒæ•¸ > è‡ªè¨‚ ID > Firebase åŒ¿å ID
                    const customId = getCustomUserId();
                    userId = sharedUserId || customId || user.uid;
                    const isUsingCustomId = getCustomUserId() !== null;
                    const isViewingShared = sharedUserId !== null;
                    const displayId = userId.length > 12 ? userId.substring(0, 8) + '...' : userId;

                    document.getElementById('auth-status').innerHTML = `
                        <span class="hidden" id="actual-user-id">${userId}</span>
                        ${isViewingShared ? '<span class="text-xs text-orange-600 bg-orange-50 px-2 py-1 rounded-lg mr-2 font-medium">ğŸ‘ï¸ æŸ¥çœ‹æ¨¡å¼</span>' : ''}
                        ${!isViewingShared ? `<button onclick="window.app.setCustomId()" class="text-xs ${isUsingCustomId ? 'text-green-600 bg-green-50 font-semibold' : 'text-gray-600 bg-gray-100'} px-2 py-1 rounded-lg hover:bg-opacity-80 transition mr-2" title="${isUsingCustomId ? 'é»æ“Šä¿®æ”¹è‡ªè¨‚ID' : 'é»æ“Šè¨­ç½®è‡ªè¨‚ID'}">
                            ğŸ†” ${isUsingCustomId ? displayId : 'è¨­ç½®ID'}
                        </button>` : ''}
                        <button onclick="window.app.copyShareLink()" class="text-xs text-indigo-600 hover:text-indigo-800 flex items-center bg-indigo-50 px-2 py-1 rounded-lg hover:bg-indigo-100 transition mr-2" title="è¤‡è£½åˆ†äº«é€£çµ">
                            <i data-lucide="share-2" class="lucide-icon w-3 h-3 mr-1"></i>
                            åˆ†äº«
                        </button>
                        <span class="text-xs text-gray-500 flex items-center" title="å·²é€£æ¥ Firebase è³‡æ–™åº«">
                            <i data-lucide="database" class="lucide-icon w-3 h-3 mr-1 text-indigo-500"></i>
                            å·²é€£æ¥
                        </span>
                    `;
                    lucide.createIcons();
                    
                    // ğŸš€ å„ªåŒ–é»ï¼šç«‹å³æ¸²æŸ“ UI éª¨æ¶ (åŒ…å«ç¯©é¸å™¨å’Œæ–°å¢åˆ†é¡æŒ‰éˆ•)
                    renderUI();
                    setupSearchListener();
                    renderUserTabs(); 

                    if (db) {
                        listenForSamples();
                        // æª¢æŸ¥æ˜¯å¦éœ€è¦é·ç§»æ•¸æ“š
                        migrateDataIfNeeded();
                    }
                } else {
                    signInAnonymously(auth).catch((error) => {
                        console.error("Sign in failed:", error);
                        showModal('èªè­‰éŒ¯èª¤', 'ç„¡æ³•ç™»å…¥: ' + error.message);
                    });
                }
            });
        };

        
        // --- 4. Firestore è³‡æ–™æ“ä½œ (ä¿æŒä¸è®Š) ---

        
        // ğŸ”„ æ•¸æ“šé·ç§»å‡½æ•¸
        const migrateDataIfNeeded = async () => {
            if (!db || !userId || !originalAuthUid) return;

            const customId = getCustomUserId();
            if (!customId || customId === originalAuthUid) return;

            // æª¢æŸ¥è‡ªè¨‚IDè·¯å¾‘æ˜¯å¦æœ‰æ•¸æ“š
            const customIdPath = collection(db, `artifacts/${appId}/users/${customId}/text_samples`);
            const customIdSnapshot = await getDocs(query(customIdPath));

            // å¦‚æœè‡ªè¨‚IDè·¯å¾‘å·²æœ‰æ•¸æ“šï¼Œä¸éœ€è¦é·ç§»
            if (!customIdSnapshot.empty) {
                console.log('è‡ªè¨‚IDè·¯å¾‘å·²æœ‰æ•¸æ“šï¼Œç„¡éœ€é·ç§»');
                return;
            }

            // å¾åŸå§‹è·¯å¾‘è®€å–æ•¸æ“š
            const originalPath = collection(db, `artifacts/${appId}/users/${originalAuthUid}/text_samples`);
            const originalSnapshot = await getDocs(query(originalPath));

            if (originalSnapshot.empty) {
                console.log('åŸå§‹è·¯å¾‘æ²’æœ‰æ•¸æ“š');
                return;
            }

            console.log(`é–‹å§‹é·ç§» ${originalSnapshot.size} ç­†æ•¸æ“š...`);

            // è¤‡è£½æ•¸æ“šåˆ°æ–°è·¯å¾‘
            let migratedCount = 0;
            for (const doc of originalSnapshot.docs) {
                const data = doc.data();
                try {
                    await addDoc(customIdPath, data);
                    migratedCount++;
                } catch (error) {
                    console.error('é·ç§»æ•¸æ“šå¤±æ•—:', error);
                }
            }

            console.log(`æ•¸æ“šé·ç§»å®Œæˆï¼š${migratedCount}/${originalSnapshot.size} ç­†`);
            if (migratedCount > 0) {
                showModal('æ•¸æ“šå·²é·ç§»', `å·²æˆåŠŸå°‡ ${migratedCount} ç­†æ–‡æœ¬é·ç§»åˆ°æ–°IDã€‚`);
                // é‡æ–°è¼‰å…¥æ•¸æ“š
                if (typeof listenForSamples === 'function') {
                    listenForSamples();
                }
            }
        };

        const getSamplesCollectionRef = () => {
            if (!userId || !db) {
                console.error("User ID or Firestore service is not set. Cannot get collection reference.");
                // ğŸš¨ å¦‚æœç¼ºå°‘ userIdï¼Œè¿”å› nullï¼ŒlistenForSamples å°‡æœƒé€€å‡º
                return null;
            }
            if (currentProfileName === 'æ‰€æœ‰æ–‡æœ¬') {
                return collection(db, `artifacts/${appId}/users/${userId}/text_samples`);
            } else {
                return collection(db, `artifacts/${appId}/profiles/${currentProfileName}/text_samples`);
            }
        };

        const listenForSamples = () => {
            const colRef = getSamplesCollectionRef();
            if (!colRef) return; // å¦‚æœæ²’æœ‰ refï¼Œå‰‡é€€å‡º

            const q = query(colRef);
            
            onSnapshot(q, (snapshot) => {
                samples = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                samples.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                
                renderUI(); // æ•¸æ“šè¼‰å…¥å®Œæˆå¾Œå†æ¬¡æ¸²æŸ“ï¼Œé¡¯ç¤ºæ¨£æœ¬å’Œæ­£ç¢ºçš„è¨ˆæ•¸
            }, (error) => {
                console.error("Error listening to Firestore:", error);
                // å³ä½¿ç›£è½å¤±æ•—ï¼Œä¹Ÿå˜—è©¦æ¸²æŸ“ UIï¼Œé¿å…å¡åœ¨è¼‰å…¥ä¸­
                showModal('éŒ¯èª¤', 'ç„¡æ³•é€£æ¥åˆ°è³‡æ–™åº«ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šã€‚');
                renderUI(); 
            });
        };

        const saveSample = async (data) => {
            const colRef = getSamplesCollectionRef();
            if (!colRef) {
                showModal('éŒ¯èª¤', 'è³‡æ–™åº«æœå‹™å°šæœªæº–å‚™å¥½ã€‚', 'alert-octagon');
                return;
            }

            try {
                if (data.id) {
                    const docRef = doc(colRef, data.id);
                    await updateDoc(docRef, {
                        title: data.title,
                        content_ch: data.content_ch,
                        content_en: data.content_en,
                        category: data.category,
                        createdBy: userId || "anonymous",
                    timestamp: serverTimestamp()
                    });
                    showModal('æˆåŠŸ', 'æ¨£æœ¬å·²æˆåŠŸæ›´æ–°ï¼', 'check-circle');
                } else {
                    await addDoc(colRef, {
                        title: data.title || 'ç„¡æ¨™é¡Œæ¨£æœ¬',
                        content_ch: data.content_ch || '',
                        content_en: data.content_en || '',
                        category: data.category || 'æœªåˆ†é¡',
                        createdBy: userId || "anonymous",
                    timestamp: serverTimestamp()
                    });
                    showModal('æˆåŠŸ', 'æ–°çš„æ–‡å­—æ¨£æœ¬å·²å»ºç«‹ï¼', 'plus-circle');
                }
            } catch (error) {
                console.error("Error saving sample:", error);
                showModal('éŒ¯èª¤', `å„²å­˜å¤±æ•—: ${error.message}`);
            }
        };

        const deleteSample = async (id) => {
            if (!id) return;
            const colRef = getSamplesCollectionRef();
            if (!colRef) {
                showModal('éŒ¯èª¤', 'è³‡æ–™åº«æœå‹™å°šæœªæº–å‚™å¥½ã€‚', 'alert-octagon');
                return;
            }

            try {
                const docRef = doc(colRef, id);
                await deleteDoc(docRef);
                showModal('åˆªé™¤æˆåŠŸ', 'æ–‡å­—æ¨£æœ¬å·²ç§»é™¤ã€‚', 'trash-2');
            } catch (error) {
                console.error("Error deleting sample:", error);
                showModal('éŒ¯èª¤', `åˆªé™¤å¤±æ•—: ${error.message}`);
            }
        };
        
        // --- 5. UI è¼”åŠ©èˆ‡æ¨¡æ…‹æ¡†é‚è¼¯ (ä¿æŒä¸è®Š) ---

        // éš±è—æ¨¡æ…‹æ¡†
        const hideModal = () => {
            const modal = document.getElementById('custom-modal');
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0', 'pointer-events-none');
        };

        // é¡¯ç¤ºè‡ªå®šç¾©æ¨¡æ…‹æ¡† (ç”¨æ–¼ä»£æ›¿ alert/confirm)
        const showModal = (title, message, icon = 'info') => {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            
            const iconHtml = `<i data-lucide="${icon}" class="lucide-icon text-indigo-600 w-6 h-6 mr-2"></i>`;
            document.getElementById('modal-icon-container').innerHTML = iconHtml;
            lucide.createIcons();

            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100');

            // 5ç§’å¾Œè‡ªå‹•é—œé–‰
            setTimeout(() => {
                hideModal();
            }, 5000);
        };
        
        // è™•ç†åˆªé™¤ç¢ºèª 
        const handleDeleteClick = (id) => {
            const modal = document.getElementById('confirm-modal');
            
            document.getElementById('confirm-message').textContent = 'æ‚¨ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤æ–‡å­—æ¨£æœ¬å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚';
            
            const confirmBtn = document.getElementById('confirm-action-btn');
            confirmBtn.onclick = () => {
                deleteSample(id);
                hideConfirmModal();
            };

            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100');
        };

        const hideConfirmModal = () => {
            const modal = document.getElementById('confirm-modal');
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0', 'pointer-events-none');
        };

        const showAddSampleModal = () => {
            updateNewSampleCategoryOptions();
            const modal = document.getElementById('add-sample-modal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100');
            
            document.getElementById('new-title').value = '';
            document.getElementById('new-content').value = '';
            document.getElementById('new-category').value = 'æœªåˆ†é¡';
            lucide.createIcons();
        };

        const hideAddSampleModal = () => {
            const modal = document.getElementById('add-sample-modal');
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0', 'pointer-events-none');
        };
        
        const showAddCategoryModal = () => {
            const modal = document.getElementById('add-category-modal');
            document.getElementById('new-category-name').value = '';
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100');
            lucide.createIcons();
        };

        const hideAddCategoryModal = () => {
            const modal = document.getElementById('add-category-modal');
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0', 'pointer-events-none');
        };

        const addNewCategoryAndFilter = async () => {
            const categoryNameInput = document.getElementById('new-category-name');
            const newCategoryName = categoryNameInput.value.trim();

            if (!newCategoryName) {
                showModal('éŒ¯èª¤', 'åˆ†é¡åç¨±ä¸èƒ½ç‚ºç©ºã€‚', 'alert-octagon');
                return;
            }
            
            const existingCategories = getCategories().filter(c => c !== 'å…¨éƒ¨');
            if (existingCategories.includes(newCategoryName)) {
                showModal('æ³¨æ„', `åˆ†é¡ "${newCategoryName}" å·²ç¶“å­˜åœ¨ã€‚å·²ç‚ºæ‚¨åˆ‡æ›è‡³è©²ç¯©é¸å™¨ã€‚`, 'alert-triangle');
                setCategoryFilter(newCategoryName);
                hideAddCategoryModal();
                return;
            }

            const placeholderSample = {
                title: `æ–°åˆ†é¡é ç•™é …ç›®: ${newCategoryName}`,
                content: `é€™æ˜¯ç‚ºæ–°åˆ†é¡ã€Œ${newCategoryName}ã€å»ºç«‹çš„é ç•™æ¨£æœ¬ã€‚è«‹ç·¨è¼¯æˆ–åˆªé™¤æ­¤é …ç›®ã€‚`,
                category: newCategoryName
            };

            try {
                await saveSample(placeholderSample);
                setCategoryFilter(newCategoryName);
                hideAddCategoryModal();
                showModal('åˆ†é¡æ–°å¢æˆåŠŸ', `å·²å»ºç«‹æ–°åˆ†é¡ã€Œ${newCategoryName}ã€ä¸¦åˆ‡æ›ç¯©é¸ã€‚`, 'folder-check');
            } catch (error) {
                showModal('éŒ¯èª¤', `ç„¡æ³•æ–°å¢åˆ†é¡: ${error.message}`, 'alert-octagon');
            }
        };

        const toggleEditMode = (id) => {
            const sampleCard = document.getElementById(`sample-${id}`);
            if (!sampleCard) return;

            const isCurrentlyEditing = activeEditId === id;

            if (isCurrentlyEditing) {
                const titleInput = sampleCard.querySelector('#edit-title');
                const contentChInput = sampleCard.querySelector('#edit-content-ch');
                const contentEnInput = sampleCard.querySelector('#edit-content-en');
                const categorySelect = sampleCard.querySelector('#edit-category');
                
                const updatedSample = {
                    id: id,
                    title: titleInput.value,
                    content_ch: contentChInput.value,
                    content_en: contentEnInput.value,
                    category: categorySelect.value
                };
                
                saveSample(updatedSample);
                activeEditId = null;

            } else {
                if (activeEditId) {
                    activeEditId = null;
                    renderUI(); 
                }
                activeEditId = id;
            }
            renderUI();
        };

        
        const setUserFilter = (user) => {
            currentUserFilter = user;
            renderUI();
        };

        const setCategoryFilter = (category) => {
            currentCategoryFilter = category;
            renderUI();
        };

        
        const getUsers = () => {
            const userSet = new Set();
            samples.forEach(s => {
                if (s.createdBy) userSet.add(s.createdBy);
            });
            return Array.from(userSet).sort();
        };

        const getCategories = () => {
            const categorySet = new Set(samples.map(s => s.category).filter(c => c));
            let categories = [...Array.from(categorySet).sort(), 'å…¨éƒ¨'];

            // Apply custom order
            const customOrder = JSON.parse(localStorage.getItem('hkt_category_order') || '[]');
            if (customOrder.length > 0) {
                const ordered = customOrder.filter(c => categories.includes(c));
                const unordered = categories.filter(c => !customOrder.includes(c));
                categories = [...ordered, ...unordered];
            }

            return categories;
        };
        
        const updateNewSampleCategoryOptions = () => {
            
            // ç”¨æˆ¶ç¯©é¸ UI
            const users = getUsers();
            const userFilterContainer = document.getElementById('user-filter-container');
            if (userFilterContainer && users.length > 0) {
                userFilterContainer.innerHTML = `
                    <span class="text-sm font-bold text-gray-500 mr-3">ç”¨æˆ¶ï¼š</span>
                    <button onclick="window.app.setUserFilter('')" 
                        class="px-4 py-2 text-sm rounded-lg ${!currentUserFilter ? 'bg-purple-600 text-white' : 'bg-gray-100'}">
                        å…¨éƒ¨
                    </button>
                    ${users.map(user => `
                        <button onclick="window.app.setUserFilter('${user}')" 
                            class="px-4 py-2 text-sm rounded-lg ${currentUserFilter === user ? 'bg-purple-600 text-white' : 'bg-gray-100'}">
                            ${user}
                        </button>
                    `).join('')}
                `;
            }

            const categories = getCategories();
            const categorySelect = document.getElementById('new-category');
            if (!categorySelect) return;

            const categoryOptions = categories.filter(c => c !== 'å…¨éƒ¨').map(cat => 
                `<option value="${cat}">${cat}</option>`
            ).join('');

            categorySelect.innerHTML = `
                <option value="æœªåˆ†é¡">æœªåˆ†é¡</option>
                ${categoryOptions}
                <option value="æ–°å¢åˆ†é¡">--- è«‹ä½¿ç”¨ç¯©é¸å™¨å€åŸŸæŒ‰éˆ• ---</option>
            `;
        };
        
        // --- 9. ä¸»æ¸²æŸ“å‡½å¼ï¼šä¿®å¾©é¦–æ®µè½ç©ºä½ä¸¦æ–°å¢æŒ‰éˆ• (ä¿æŒä¸è®Š) ---
        const renderSampleCard = (sample) => {
            const date = sample.timestamp ? new Date(sample.timestamp.seconds * 1000).toLocaleString('zh-TW', {
                year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit'
            }) : 'å°šæœªå„²å­˜';

            const categories = getCategories();
            const categoryOptions = categories.filter(c => c !== 'å…¨éƒ¨').map(cat => 
                `<option value="${cat}" ${sample.category === cat ? 'selected' : ''}>${cat}</option>`
            ).join('');
            if (!categories.includes(sample.category) && sample.category) {
                 categoryOptions.unshift(`<option value="${sample.category}" selected>${sample.category}</option>`);
            }
            
            const editCategorySelect = `
                <select id="edit-category" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                    ${categoryOptions}
                    <option value="æœªåˆ†é¡" ${sample.category === 'æœªåˆ†é¡' ? 'selected' : ''}>æœªåˆ†é¡</option>
                </select>
            `;

            const isEditing = activeEditId === sample.id;

            // ç”¨ JSON.stringify åŒ…è£ sample.content ä¸¦ä½¿ç”¨åå¼•è™Ÿæ¨¡æ¿ï¼Œç¢ºä¿å…§å®¹èƒ½æ­£ç¢ºå‚³éçµ¦ translateSample å‡½å¼
            const escapedContent = JSON.stringify(sample.content_ch || "").slice(1, -1).replace(/\\/g, '\\\\').replace(/'/g, '\\\'');

            // ä¿®æ­£ï¼šä½¿ç”¨ .trim() ç§»é™¤é¦–å°¾ç©ºç™½å’Œç©ºè¡Œï¼Œè§£æ±ºé¦–æ®µè½ç©ºä½å•é¡Œ
            const displayContent = (sample.content_ch || "").trim().replace(/\n/g, '<br>');

            return `
                <div id="sample-${sample.id}" class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition duration-300 flex flex-col h-full border-t-4 border-indigo-500">
                    <div class="flex justify-between items-start mb-4">
                        ${isEditing ? `
                            <input id="edit-title" value="${sample.title}" class="text-xl font-bold text-gray-800 w-full border-b border-gray-300 p-1 mb-2 focus:outline-none focus:border-indigo-500">
                        ` : `
                            <h3 class="text-xl font-bold text-gray-800">${sample.title}</h3>
                        `}
                        <div class="flex-shrink-0 ml-4 flex space-x-2">
                            ${!isEditing ? `
                            <button onclick="window.app.copyText('${sample.id}', 'ch')" class="text-white bg-blue-400 hover:bg-blue-500 p-2 rounded-full shadow-md transition duration-150" title="è¤‡è£½ä¸­æ–‡">
                                <i data-lucide="copy" class="lucide-icon w-4 h-4"></i>
                            </button>
                            <button onclick="window.app.copyText('${sample.id}', 'en')" class="text-white bg-green-400 hover:bg-green-500 p-2 rounded-full shadow-md transition duration-150" title="è¤‡è£½è‹±æ–‡">
                                <i data-lucide="languages" class="lucide-icon w-4 h-4"></i>
                            </button>
                            ` : ''}
                            
                            <button onclick="window.app.toggleEditMode('${sample.id}')" class="text-white ${isEditing ? 'bg-green-500 hover:bg-green-600' : 'bg-indigo-500 hover:bg-indigo-600'} p-2 rounded-full shadow-md transition duration-150">
                                <i data-lucide="${isEditing ? 'save' : 'edit'}" class="lucide-icon w-4 h-4"></i>
                            </button>
                            ${isEditing ? '' : `
                                <button onclick="window.app.handleDeleteClick('${sample.id}')" class="text-white bg-red-500 hover:bg-red-600 p-2 rounded-full shadow-md transition duration-150">
                                    <i data-lucide="trash-2" class="lucide-icon w-4 h-4"></i>
                                </button>
                            `}
                        </div>
                    </div>

                    <div class="mb-4 text-sm font-medium flex items-center justify-between">
                    <div class="text-indigo-600 flex items-center">
                        <i data-lucide="tag" class="lucide-icon w-4 h-4 mr-1"></i>
                        ${isEditing ? editCategorySelect : `
                            <span class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-semibold">${sample.category}</span>
                        `}
                    </div>
                    
                    ${isEditing ? `
                        
                        <div class="flex flex-col space-y-2 h-96">
                            <label class="text-xs font-bold text-gray-500">ä¸­æ–‡å…§å®¹</label>
                            <textarea id="edit-content-ch" class="flex-grow w-full border border-gray-300 p-2 rounded-lg resize-none focus:ring-indigo-500">${sample.content_ch || ''}</textarea>
                            <label class="text-xs font-bold text-gray-500">è‹±æ–‡å…§å®¹</label>
                            <textarea id="edit-content-en" class="flex-grow w-full border border-gray-300 p-2 rounded-lg resize-none focus:ring-indigo-500">${sample.content_en || ''}</textarea>
                        </div>

                    ` : `
                        <div class="flex-grow text-gray-700 sample-content overflow-auto mb-4 border p-3 rounded-lg bg-gray-50 max-h-64">
                            ${displayContent}
                        </div>
                    `}

                    <p class="text-xs text-gray-500 mt-auto pt-2 border-t border-gray-100">
                        æœ€å¾Œç·¨è¼¯æ–¼: ${date}
                    </p>
                </div>
            `;
        };
        
        const createNewSample = () => {
            const titleInput = document.getElementById('new-title');
            const contentChInput = document.getElementById('new-content-ch');
            const contentEnInput = document.getElementById('new-content-en');
            const categorySelect = document.getElementById('new-category');
            
            let category = categorySelect.value;
            
            if (category === 'æ–°å¢åˆ†é¡') {
                showModal('æ³¨æ„', 'è«‹åœ¨ä¸Šæ–¹ã€Œç¯©é¸å™¨ã€å€åŸŸä½¿ç”¨ã€Œæ–°å¢åˆ†é¡ã€æŒ‰éˆ•ä¾†å»ºç«‹æ–°åˆ†é¡ï¼Œæˆ–é¸æ“‡ä¸€å€‹ç¾æœ‰çš„åˆ†é¡ã€‚', 'alert-triangle');
                return; 
            }
            
            const newSample = {
                title: titleInput.value || 'ç„¡æ¨™é¡Œæ¨£æœ¬',
                content_ch: contentChInput.value || '',
                content_en: contentEnInput.value || '',
                category: category
            };

            if (!newSample.content_ch.trim() && !newSample.content_en.trim()) {
                showModal('æ³¨æ„', 'å…§å®¹ä¸èƒ½ç‚ºç©ºï¼', 'alert-triangle');
                return;
            }

            saveSample(newSample).then(() => {
                titleInput.value = '';
                contentChInput.value = '';
                contentEnInput.value = '';
                categorySelect.value = 'æœªåˆ†é¡';
                // document.getElementById('draft-prompt').value = ''; // Removed draft prompt
                hideAddSampleModal();
            });
        };

        const renderUI = () => {
            const samplesContainer = document.getElementById('samples-container');
            const filterContainer = document.getElementById('filter-container');
            
            // ğŸš¨ é é˜²æ€§æª¢æŸ¥
            if (!samplesContainer || !filterContainer) return;
            
            const categories = getCategories();
            let categoryFiltered = currentCategoryFilter === 'å…¨éƒ¨' ? samples : samples.filter(s => s.category === currentCategoryFilter);
            let userFiltered = currentUserFilter ? categoryFiltered.filter(s => s.createdBy === currentUserFilter) : userFiltered;
            const lowerTerm = searchTerm ? searchTerm.toLowerCase().trim() : '';
            const filteredSamples = lowerTerm ? userFiltered.filter(s => (s.title && s.title.toLowerCase().includes(lowerTerm)) || (s.content_ch && s.content_ch.toLowerCase().includes(lowerTerm)) || (s.content_en && s.content_en.toLowerCase().includes(lowerTerm))) : categoryFiltered;

            filterContainer.innerHTML = categories.map((cat, idx) => `
                <div class="inline-flex items-center bg-white rounded-lg shadow-md border border-gray-200 hover:shadow-lg transition-shadow">
                    ${idx > 0 ? `<button onclick="window.app.moveCategoryLeft('${cat}')" class="pl-2 pr-1 py-2 hover:bg-gray-100 transition rounded-l-lg" title="å‘å·¦ç§»å‹•">
                        â†
                    </button>` : '<span class="w-2"></span>'}
                    <button 
                        onclick="window.app.setCategoryFilter('${cat}')"
                        class="px-4 py-2 text-sm font-semibold transition duration-150 ${currentCategoryFilter === cat 
                            ? 'bg-indigo-600 text-white' 
                            : 'text-gray-700 hover:bg-indigo-100'}"
                    >
                        ${cat} (${cat === 'å…¨éƒ¨' ? samples.length : samples.filter(s => s.category === cat).length})
                    </button>
                    ${idx < categories.length - 1 ? `<button onclick="window.app.moveCategoryRight('${cat}')" class="pr-2 pl-1 py-2 hover:bg-gray-100 transition rounded-r-lg" title="å‘å³ç§»å‹•">
                        â†’
                    </button>` : '<span class="w-2"></span>'}
                </div>
            `).join('') + `
                <button 
                    onclick="window.app.showAddCategoryModal()"
                    class="px-4 py-2 text-sm font-semibold rounded-lg transition duration-150 bg-indigo-50 border border-indigo-300 text-indigo-700 hover:bg-indigo-200 hover:shadow-md flex items-center shadow-sm"
                >
                    <i data-lucide="plus" class="lucide-icon w-4 h-4 mr-1"></i>
                    æ–°å¢åˆ†é¡
                </button>
            `;

            if (filteredSamples.length === 0) {
                // åªæœ‰åœ¨æ¨£æœ¬ç‚ºç©ºæ™‚æ‰é¡¯ç¤ºåŠ è¼‰æç¤ºï¼Œå¦å‰‡æ‡‰è©²é¡¯ç¤ºã€Œæ­£åœ¨è¼‰å…¥æ‚¨çš„ä½œå“...ã€
                // å¦‚æœ samples ç‚ºç©ºï¼Œä½† userId å·²ç¶“è¨­ç½®ï¼Œå‰‡é¡¯ç¤ºå‰µå»ºæç¤º
                if (samples.length === 0 && userId) {
                     samplesContainer.innerHTML = `
                        <div class="col-span-full text-center py-10 bg-white rounded-xl shadow-inner text-gray-500">
                            <i data-lucide="book-open" class="lucide-icon w-12 h-12 mx-auto mb-4 text-gray-300"></i>
                            <p class="text-lg">ç›®å‰åœ¨é€™å€‹åˆ†é¡ä¸­æ²’æœ‰æ–‡å­—æ¨£æœ¬ã€‚</p>
                            <p class="text-sm">é»æ“Šå³ä¸Šè§’çš„ã€Œæ–°å¢æ–‡å­—æ¨£æœ¬ã€æŒ‰éˆ•é–‹å§‹å‰µå»ºå§ï¼</p>
                        </div>
                    `;
                } else if (!userId) {
                    // ğŸš¨ å¦‚æœç”¨æˆ¶ ID é‚„æ²’æ‹¿åˆ°ï¼Œä¿æŒåŸå§‹çš„åŠ è¼‰ä¸­ç‹€æ…‹
                    samplesContainer.innerHTML = `
                        <div class="col-span-full text-center py-10 text-gray-400">
                            <i data-lucide="loader" class="lucide-icon w-8 h-8 mx-auto mb-2 animate-spin"></i>
                            <p>æ­£åœ¨è¼‰å…¥æ‚¨çš„ä½œå“...</p>
                        </div>
                    `;
                } else {
                    // å·²ç¶“è¼‰å…¥éè³‡æ–™ï¼Œä½†åœ¨ç•¶å‰åˆ†é¡ä¸‹æ²’æœ‰æ¨£æœ¬
                     samplesContainer.innerHTML = `
                        <div class="col-span-full text-center py-10 bg-white rounded-xl shadow-inner text-gray-500">
                            <i data-lucide="folder-open" class="lucide-icon w-12 h-12 mx-auto mb-4 text-gray-300"></i>
                            <p class="text-lg">æ­¤åˆ†é¡ã€Œ${currentCategoryFilter}ã€ä¸­æ²’æœ‰ä»»ä½•æ¨£æœ¬ã€‚</p>
                            <p class="text-sm">è«‹åˆ‡æ›åˆ†é¡æˆ–æ–°å¢æ¨£æœ¬ã€‚</p>
                        </div>
                    `;
                }
            } else {
                samplesContainer.innerHTML = filteredSamples.map(renderSampleCard).join('');
            }
            
            lucide.createIcons();
        };

        // --- 10. å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼ ---
        window.app = {
            switchProfile: (name) => {
                if (name === currentProfileName) return;
                currentProfileName = name;
                localStorage.setItem('hkt_current_profile', name);
                renderUserTabs();
                listenForSamples();
            },

            addProfile: () => {
                const name = prompt("è«‹è¼¸å…¥æ–°ç”¨æˆ¶åç¨±ï¼š");
                if (name && name.trim()) {
                    const clean = name.trim();
                    if (clean === 'æ‰€æœ‰æ–‡æœ¬') {
                        alert("æ­¤åç¨±ç‚ºç³»çµ±ä¿ç•™");
                        return;
                    }
                    if (!profiles.includes(clean)) {
                        profiles.push(clean);
                        localStorage.setItem('hkt_profiles', JSON.stringify(profiles));
                        window.app.switchProfile(clean);
                    } else {
                        alert("ç”¨æˆ¶å·²å­˜åœ¨");
                    }
                }
            },

            deleteProfile: (name) => {
                if (name === 'æ‰€æœ‰æ–‡æœ¬') {
                    alert("ç„¡æ³•åˆªé™¤ç³»çµ±ä¿ç•™çš„ç”¨æˆ¶");
                    return;
                }
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤ç”¨æˆ¶ã€Œ${name}ã€å—ï¼Ÿ\n\næ³¨æ„ï¼šæ­¤æ“ä½œä¸æœƒåˆªé™¤è©²ç”¨æˆ¶çš„æ–‡æœ¬æ•¸æ“šï¼Œåªæ˜¯å¾åˆ—è¡¨ä¸­ç§»é™¤ã€‚`)) {
                    return;
                }
                profiles = profiles.filter(p => p !== name);
                localStorage.setItem('hkt_profiles', JSON.stringify(profiles));
                if (name === currentProfileName) {
                    window.app.switchProfile('æ‰€æœ‰æ–‡æœ¬');
                } else {
                    renderUserTabs();
                }
            },

            moveCategoryLeft: (cat) => {
                const categories = getCategories();
                const idx = categories.indexOf(cat);
                if (idx > 0) {
                    [categories[idx], categories[idx-1]] = [categories[idx-1], categories[idx]];
                    localStorage.setItem('hkt_category_order', JSON.stringify(categories));
                    renderUI();
                }
            },

            moveCategoryRight: (cat) => {
                const categories = getCategories();
                const idx = categories.indexOf(cat);
                if (idx < categories.length - 1) {
                    [categories[idx], categories[idx+1]] = [categories[idx+1], categories[idx]];
                    localStorage.setItem('hkt_category_order', JSON.stringify(categories));
                    renderUI();
                }
            },


            
            copyText: (id, lang) => {
                const sample = samples.find(s => s.id === id);
                if(!sample) return;
                const text = lang === 'ch' ? sample.content_ch : sample.content_en;
                if(!text) return alert('è©²èªè¨€å…§å®¹ç‚ºç©º');
                navigator.clipboard.writeText(text).then(() => {
                    showModal('è¤‡è£½æˆåŠŸ', (lang==='ch'?'ä¸­æ–‡':'è‹±æ–‡') + 'å…§å®¹å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'check');
                    setTimeout(() => window.app.hideModal(), 1500);
                });
            },

            setCategoryFilter,
            toggleEditMode,
            createNewSample,
            handleDeleteClick,
            hideConfirmModal,
            setCustomId: async () => {
                const currentCustomId = getCustomUserId();
                const currentMessage = currentCustomId 
                    ? `ç•¶å‰è‡ªè¨‚IDï¼š${currentCustomId}\n\nè¼¸å…¥æ–°IDä¾†æ›´æ”¹ï¼Œæˆ–ç•™ç©ºå–æ¶ˆï¼š` 
                    : 'è¨­ç½®ä¸€å€‹ç°¡çŸ­çš„è‡ªè¨‚IDï¼ˆä¾‹å¦‚ï¼škiwi123ï¼‰\n\né€™æ¨£åˆ†äº«é€£çµæœƒæ›´çŸ­æ›´å¥½è¨˜ï¼\n\nâš ï¸ è¨­ç½®å¾Œæœƒè‡ªå‹•é·ç§»æ‚¨çš„æ‰€æœ‰æ–‡æœ¬ã€‚';

                const newId = prompt(currentMessage, currentCustomId || '');

                if (newId === null) return;

                if (newId.trim() === '') {
                    if (currentCustomId) {
                        showModal('æç¤º', 'å¦‚éœ€åˆªé™¤è‡ªè¨‚IDï¼Œè«‹ç›´æ¥ä½¿ç”¨åŸå§‹IDåˆ†äº«é€£çµã€‚');
                    }
                    return;
                }

                if (!/^[a-zA-Z0-9_]{3,20}$/.test(newId.trim())) {
                    showModal('æ ¼å¼éŒ¯èª¤', 'IDåªèƒ½åŒ…å«è‹±æ–‡ã€æ•¸å­—å’Œåº•ç·šï¼Œé•·åº¦3-20å­—ç¬¦ã€‚');
                    return;
                }

                if (setCustomUserId(newId)) {
                    showModal('è¨­ç½®æˆåŠŸ', `è‡ªè¨‚IDå·²è¨­ç½®ç‚ºï¼š${newId}\n\næ­£åœ¨é‡æ–°è¼‰å…¥é é¢ä¸¦é·ç§»æ•¸æ“š...`);
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                }
            },

            copyShareLink: () => {
                const currentUserId = sharedUserId || userId;
                const shareUrl = `${window.location.origin}${window.location.pathname}?userId=${currentUserId}`;

                navigator.clipboard.writeText(shareUrl).then(() => {
                    showModal('åˆ†äº«é€£çµå·²è¤‡è£½ ğŸ“‹', `æ‚¨å¯ä»¥å°‡æ­¤é€£çµåˆ†äº«çµ¦å…¶ä»–è¨­å‚™ï¼š\n\n${shareUrl}\n\nğŸ’¡ æç¤ºï¼š\nâ€¢ å°‡é€£çµåŠ å…¥æ›¸ç±¤ï¼Œæ–¹ä¾¿ä¸‹æ¬¡ä½¿ç”¨\nâ€¢ æ›´æ–°å…§å®¹æœƒè‡ªå‹•åŒæ­¥ï¼Œä¸éœ€é‡æ–°åˆ†äº«\nâ€¢ å…¶ä»–äººåªèƒ½æŸ¥çœ‹ï¼Œç„¡æ³•ç·¨è¼¯`);
                }).catch(err => {
                    showModal('åˆ†äº«é€£çµ', `è«‹è¤‡è£½ä»¥ä¸‹é€£çµï¼š\n\n${shareUrl}`);
                });
            },

            showAddSampleModal,
            hideAddSampleModal,
            showAddCategoryModal,
            hideAddCategoryModal,
            addNewCategoryAndFilter,
            hideModal, 
            saveSample,
            renderUI,
             
            
             
        };
        
        window.onload = () => {
            // æª¢æŸ¥ Firebase æ˜¯å¦æˆåŠŸåˆå§‹åŒ–
            if (auth && db) {
                signInAndListen();
            } else {
                console.warn("Firebase æœªæˆåŠŸåˆå§‹åŒ–ï¼Œè·³éèªè­‰æµç¨‹ã€‚");
            }
        };

    </script>
</head>
<body class="bg-gray-50 min-h-screen">

    
    
    
    
    <!-- è‡ªå®šç¾©è¨Šæ¯æ¨¡æ…‹æ¡† (Custom Modal) -->
    <div id="custom-modal" class="custom-modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-95" onclick="event.stopPropagation()">
            <div class="flex items-center mb-4">
                <span id="modal-icon-container"></span>
                <h3 id="modal-title" class="text-lg font-bold text-gray-800">è¨Šæ¯</h3>
                <button onclick="window.app.hideModal()" class="ml-auto text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="lucide-icon w-5 h-5"></i>
                </button>
            </div>
            <p id="modal-message" class="text-gray-600 mb-4"></p>
            <div class="flex justify-end">
                <button onclick="window.app.hideModal()" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition duration-150">ç¢ºå®š</button>
            </div>
        </div>
    </div>
    
    <!-- ç¢ºèªåˆªé™¤æ¨¡æ…‹æ¡† (Confirm Modal) -->
    <div id="confirm-modal" class="custom-modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-95" onclick="event.stopPropagation()">
            <div class="flex items-center mb-4">
                <i data-lucide="alert-triangle" class="lucide-icon text-red-500 w-6 h-6 mr-2"></i>
                <h3 class="text-lg font-bold text-gray-800">ç¢ºèªæ“ä½œ</h3>
            </div>
            <p id="confirm-message" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button onclick="window.app.hideConfirmModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150">å–æ¶ˆ</button>
                <button id="confirm-action-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150">ç¢ºèªåˆªé™¤</button>
            </div>
        </div>
    </div>
    
    <!-- æ–°å¢æ¨£æœ¬æ¨¡æ…‹æ¡† (Add Sample Modal) -->
    <div id="add-sample-modal" class="custom-modal fixed inset-0 z-40 flex items-center justify-center bg-black bg-opacity-70 opacity-0 pointer-events-none" onclick="window.app.hideAddSampleModal()">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto transform transition-all duration-300 modal-content-transition scale-90" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h2 class="text-2xl font-extrabold text-indigo-800 flex items-center">
                    <i data-lucide="pen-tool" class="lucide-icon w-6 h-6 mr-2"></i>
                    æ–°å¢æ–‡å­—æ¨£æœ¬
                </h2>
                <button onclick="window.app.hideAddSampleModal()" class="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100">
                    <i data-lucide="x" class="lucide-icon w-6 h-6"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="col-span-3 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ¨™é¡Œ</label>
                        <input type="text" id="new-title" class="w-full border border-gray-300 p-3 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm" placeholder="ç‚ºé€™å€‹ä½œå“å–å€‹åå­—...">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">åˆ†é¡</label>
                        <select id="new-category" class="w-full border border-gray-300 p-3 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm bg-white">
                            <option value="æœªåˆ†é¡">æœªåˆ†é¡</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ä¸­æ–‡å…§å®¹ (Chinese Content)</label>
                        <textarea id="new-content-ch" class="w-full h-64 border border-gray-300 p-3 rounded-lg resize-none focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm" placeholder="åœ¨é€™è£¡è¼¸å…¥æˆ–è²¼ä¸Šæ‚¨çš„æ–‡å­—å…§å®¹..."></textarea>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">è‹±æ–‡å…§å®¹ (English Content)</label>
                        <textarea id="new-content-en" class="w-full h-64 border border-gray-300 p-3 rounded-lg resize-none focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm" placeholder="Enter or paste your English text here..."></textarea>
                    </div>
                </div>
                
                </div>

            <div class="flex justify-end mt-6 pt-4 border-t border-gray-100 space-x-3">
                <button onclick="window.app.hideAddSampleModal()" class="px-5 py-2 bg-white border border-gray-300 text-gray-700 rounded-full hover:bg-gray-50 transition duration-150 font-medium">å–æ¶ˆ</button>
                <button onclick="window.app.createNewSample()" class="px-6 py-2 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition duration-150 shadow-md flex items-center font-medium">
                    <i data-lucide="save" class="lucide-icon w-4 h-4 mr-2"></i>
                    å„²å­˜æ¨£æœ¬
                </button>
            </div>
        </div>
    </div>
    
    <!-- æ–°å¢åˆ†é¡æ¨¡æ…‹æ¡† -->
    <div id="add-category-modal" class="custom-modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-95" onclick="event.stopPropagation()">
             <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">æ–°å¢åˆ†é¡</h3>
                <button onclick="window.app.hideAddCategoryModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="lucide-icon w-5 h-5"></i>
                </button>
            </div>
            <p class="text-sm text-gray-600 mb-4">è«‹è¼¸å…¥æ–°åˆ†é¡çš„åç¨±ï¼š</p>
            <input type="text" id="new-category-name" class="w-full border border-gray-300 p-2 rounded-lg mb-4 focus:ring-indigo-500 focus:border-indigo-500" placeholder="ä¾‹å¦‚ï¼šæœƒè­°è¨˜éŒ„">
            <div class="flex justify-end space-x-2">
                <button onclick="window.app.hideAddCategoryModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150">å–æ¶ˆ</button>
                <button onclick="window.app.addNewCategoryAndFilter()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-150">æ–°å¢ä¸¦åˆ‡æ›</button>
            </div>
        </div>
    </div>

    <div id="app-container" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header Section -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-4 border-l-8 border-indigo-600 flex flex-col md:flex-row justify-between items-center relative overflow-hidden">
             <!-- èƒŒæ™¯è£é£¾ -->
            <div class="absolute top-0 right-0 -mt-10 -mr-10 w-40 h-40 bg-indigo-50 rounded-full opacity-50 pointer-events-none"></div>
            
            <div class="z-10 mb-6">
                <!-- Row 1: å·¦å´æ¨™é¡Œ + å³å´ æ–°å¢æ¨£æœ¬ + è³‡æ–™åº«ç‹€æ…‹ -->
                <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4 mb-4">
                    <!-- å·¦å´ï¼šæ¨™é¡Œ + ç”¨æˆ¶åˆ‡æ› -->
                    <div>
                        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 tracking-tight mb-2">KIWI QUICK TEXT</h1>
                        <p class="text-indigo-600 font-medium text-lg">åœ¨é€™è£¡ç®¡ç†å’Œä¿®æ”¹æ‚¨çš„æ–‡å­—ä½œå“é›†ã€‚</p>

                        <!-- ç”¨æˆ¶åˆ‡æ›åˆ— -->
                        <div class="mt-3">
                            <div id="user-tabs-container" class="inline-flex flex-wrap gap-2 items-center"></div>
                        </div>
                    </div>

                    <!-- å³å´ï¼šæ–°å¢æ–‡å­—æ¨£æœ¬ + è³‡æ–™åº«ç‹€æ…‹ï¼ˆåŒä¸€è¡Œé å³ï¼‰ -->
                    <div class="flex flex-row items-center justify-end gap-3">
                        <div id="auth-status" class="flex items-center space-x-2 bg-white px-3 py-1 rounded-full shadow border border-gray-200 text-sm text-gray-500">
                            <i data-lucide="loader" class="lucide-icon w-4 h-4 animate-spin text-indigo-500"></i>
                            <span>æ­£åœ¨é€£æ¥è³‡æ–™åº«...</span>
                        </div>

                        <button 
                            onclick="window.app.showAddSampleModal()" 
                            class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-full shadow-lg hover:shadow-xl transition flex items-center whitespace-nowrap"
                        >
                            <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                            æ–°å¢æ–‡å­—æ¨£æœ¬
                        </button>
                    </div>
                </div>

                <!-- Row 2: æœå°‹æ¨£æœ¬æ¨™é¡Œ -->
                <div class="mb-4">
                    <div class="relative max-w-md">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="search" class="w-5 h-5 text-gray-400"></i>
                        </div>
                        <input 
                            type="text" 
                            id="search-input"
                            class="block w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-xl leading-5 bg-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm"
                            placeholder="æœå°‹æ¨£æœ¬æ¨™é¡Œ..."
                        >
                    </div>
                </div>
            </div>
            </div>
            
            <div class="mt-4 md:mt-0 z-10">
                
            </div>
        </div>

        <!-- Filter & Search Section -->
        <div class="bg-white rounded-xl shadow-md p-4 mb-10 sticky top-4 z-30 bg-opacity-95 backdrop-blur-sm border border-gray-100">
            <div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
                <div class="flex items-center w-full md:w-auto overflow-x-auto pb-2 md:pb-0 no-scrollbar mask-linear-fade">
                    <span class="text-sm font-bold text-gray-500 mr-3 uppercase tracking-wider flex-shrink-0">åˆ†é¡ç¯©é¸</span>
                    <div id="user-filter-container" class="flex space-x-2 mb-4"></div>
                    <div id="filter-container" class="flex space-x-2">
                        <!-- Filters injected by JS -->
                        <span class="text-gray-400 text-sm italic">è¼‰å…¥åˆ†é¡ä¸­...</span>
                    </div>
                </div>
                
                <div class="relative w-full md:w-64 group">
                    
            </div>
        </div>

        <!-- Content Grid -->
        <div id="samples-container" class="mt-10 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-10">
            <!-- Sample Cards injected by JS -->
            <div class="col-span-full flex flex-col items-center justify-center py-20 text-gray-400 opacity-70">
                <i data-lucide="loader" class="lucide-icon w-10 h-10 mb-3 animate-spin text-indigo-300"></i>
                <p>æ­£åœ¨è¼‰å…¥æ‚¨çš„ä½œå“...</p>
            </div>
        </div>
    </div>

</body>
</html>

