<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡å­—æ¨£æœ¬èˆ‡ä½œå“é›† (AI å¢å¼·ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@100..900&display=swap');
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        .sample-content {
            white-space: pre-wrap; /* ä¿ç•™æ›è¡Œå’Œç©ºæ ¼ */
        }
        /* Custom modal for alerts/prompts */
        .custom-modal {
            transition: opacity 0.3s ease-in-out;
        }
        .lucide {
            width: 1.25rem;
            height: 1.25rem;
        }
        /* æ¨¡æ…‹æ¡†å‹•ç•« */
        .modal-content-transition {
            transition: transform 0.3s ease-out;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Firestore uses logging to console.
        setLogLevel('Debug');
        
        // --- 1. å…¨åŸŸè®Šæ•¸ã€è¨­å®šæª”èˆ‡åˆå§‹åŒ– ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // --- IMPORTANT: ä½¿ç”¨è€…è‡ªå®šç¾© Firebase è¨­å®š (è‹¥åœ¨ GitHub æˆ–æœ¬åœ°ç’°å¢ƒé‹è¡Œ) ---
        const customFirebaseConfig = {
            apiKey: "AIzaSyBnQmqGZQ_94BDgmZFzOJsKDjgYq8ipI2I",
            authDomain: "hkttext.firebaseapp.com",
            projectId: "hkttext",
            storageBucket: "hkttext.firebasestorage.app",
            messagingSenderId: "501339425536",
            appId: "1:501339425536:web:f9ddbf080a002be99701e5",
            measurementId: "G-CKY8VPMJXJ" 
        };

        const envFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const isCustomConfigReady = customFirebaseConfig.projectId !== "YOUR_PROJECT_ID" && customFirebaseConfig.projectId !== undefined;

        const firebaseConfig = envFirebaseConfig || (isCustomConfigReady ? customFirebaseConfig : null);
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;
        let samples = [];
        let currentCategoryFilter = 'å…¨éƒ¨';
        let activeEditId = null;

        if (firebaseConfig) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } else {
            console.error("Firebase configuration is missing. Data persistence will not work.");
            document.getElementById('app-container').innerHTML = `
                <div class="p-6 bg-red-100 border border-red-400 text-red-700 rounded-lg max-w-lg mx-auto mt-10">
                    <p class="font-bold">è¨­å®šéŒ¯èª¤</p>
                    <p>ç„¡æ³•è¼‰å…¥ Firebase é…ç½®ã€‚è«‹æª¢æŸ¥ç’°å¢ƒè®Šæ•¸ï¼Œæˆ–å°‡æ‚¨çš„å°ˆæ¡ˆé…ç½®è²¼å…¥ \`customFirebaseConfig\` è®Šæ•¸å…§ã€‚</p>
                </div>
            `;
        }
        
        // --- 2. Gemini API é‚è¼¯èˆ‡å·¥å…·å‡½å¼ ---
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
        const GEMINI_API_KEY = ""; // Canvas will provide this if empty
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;

        // è¼”åŠ©å‡½å¼ï¼šæŒ‡æ•¸é€€é¿ (Exponential Backoff)
        const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

        const fetchWithBackoff = async (url, options, retries = 3) => {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        if (response.status === 429 || response.status >= 500) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const errorBody = await response.text();
                        throw new Error(`API Error: ${response.status} - ${errorBody}`);
                    }
                    return response.json();
                } catch (error) {
                    if (i === retries - 1) {
                        console.error("Max retries reached. Failing request.", error);
                        throw error;
                    }
                    const backoffTime = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    console.warn(`Attempt ${i + 1} failed. Retrying in ${backoffTime / 1000}s...`);
                    await delay(backoffTime);
                }
            }
        };

        // å‘¼å« Gemini API çš„ä¸»è¦å‡½å¼
        const callGemini = async (userPrompt, systemPrompt) => {
            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            const result = await fetchWithBackoff(GEMINI_API_URL, options);
            
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!text) {
                throw new Error("Gemini response was empty or malformed.");
            }
            return text;
        };
        
        // --- 3. èªè­‰èˆ‡ä½¿ç”¨è€…è¨­å®š (å·²ä¿®æ”¹) ---
        const signInAndListen = async () => {
            if (!auth) {
                console.error("Authentication service not initialized. Skipping sign-in.");
                return;
            }
            
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Authentication failed:", error);
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('auth-status').innerHTML = `
                        <span class="hidden" id="actual-user-id">${userId}</span>
                        <span class="text-sm text-gray-500 flex items-center" title="å·²é€£æ¥ Firebase è³‡æ–™åº«">
                            <i data-lucide="database" class="lucide-icon w-4 h-4 mr-1 text-indigo-500"></i>
                            å·²é€£æ¥è³‡æ–™åº«
                        </span>
                    `;
                    lucide.createIcons();
                    
                    // ğŸš€ å„ªåŒ–é»ï¼šç«‹å³æ¸²æŸ“ UI éª¨æ¶ (åŒ…å«ç¯©é¸å™¨å’Œæ–°å¢åˆ†é¡æŒ‰éˆ•)
                    renderUI(); 

                    if (db) {
                        listenForSamples();
                    }
                } else {
                    console.log("User signed out or failed to sign in.");
                }
            });
        };
        
        // --- 4. Firestore è³‡æ–™æ“ä½œ (èˆ‡åŸç¨‹å¼ç¢¼ç›¸åŒï¼Œç•¥éè¨»é‡‹) ---

        const getSamplesCollectionRef = () => {
            if (!userId || !db) {
                console.error("User ID or Firestore service is not set. Cannot get collection reference.");
                return null;
            }
            return collection(db, `artifacts/${appId}/users/${userId}/text_samples`);
        };

        const listenForSamples = () => {
            const colRef = getSamplesCollectionRef();
            if (!colRef) return;

            const q = query(colRef);
            
            onSnapshot(q, (snapshot) => {
                samples = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                samples.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                
                renderUI(); // æ•¸æ“šè¼‰å…¥å®Œæˆå¾Œå†æ¬¡æ¸²æŸ“ï¼Œé¡¯ç¤ºæ¨£æœ¬å’Œæ­£ç¢ºçš„è¨ˆæ•¸
            }, (error) => {
                console.error("Error listening to Firestore:", error);
                showModal('éŒ¯èª¤', 'ç„¡æ³•é€£æ¥åˆ°è³‡æ–™åº«ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šã€‚');
            });
        };

        const saveSample = async (data) => {
            const colRef = getSamplesCollectionRef();
            if (!colRef) return;

            try {
                if (data.id) {
                    const docRef = doc(colRef, data.id);
                    await updateDoc(docRef, {
                        title: data.title,
                        content: data.content,
                        category: data.category,
                        timestamp: serverTimestamp()
                    });
                    showModal('æˆåŠŸ', 'æ¨£æœ¬å·²æˆåŠŸæ›´æ–°ï¼', 'check-circle');
                } else {
                    await addDoc(colRef, {
                        title: data.title || 'ç„¡æ¨™é¡Œæ¨£æœ¬',
                        content: data.content || '',
                        category: data.category || 'æœªåˆ†é¡',
                        timestamp: serverTimestamp()
                    });
                    showModal('æˆåŠŸ', 'æ–°çš„æ–‡å­—æ¨£æœ¬å·²å»ºç«‹ï¼', 'plus-circle');
                }
            } catch (error) {
                console.error("Error saving sample:", error);
                showModal('éŒ¯èª¤', `å„²å­˜å¤±æ•—: ${error.message}`);
            }
        };

        const deleteSample = async (id) => {
            if (!id) return;
            const colRef = getSamplesCollectionRef();
            if (!colRef) return;

            try {
                const docRef = doc(colRef, id);
                await deleteDoc(docRef);
                showModal('åˆªé™¤æˆåŠŸ', 'æ–‡å­—æ¨£æœ¬å·²ç§»é™¤ã€‚', 'trash-2');
            } catch (error) {
                console.error("Error deleting sample:", error);
                showModal('éŒ¯èª¤', `åˆªé™¤å¤±æ•—: ${error.message}`);
            }
        };
        
        // --- 5. UI è¼”åŠ©èˆ‡æ¨¡æ…‹æ¡†é‚è¼¯ (èˆ‡åŸç¨‹å¼ç¢¼ç›¸åŒï¼Œç•¥éè¨»é‡‹) ---

        // éš±è—æ¨¡æ…‹æ¡†
        const hideModal = () => {
            const modal = document.getElementById('custom-modal');
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0', 'pointer-events-none');
        };

        // é¡¯ç¤ºè‡ªå®šç¾©æ¨¡æ…‹æ¡† (ç”¨æ–¼ä»£æ›¿ alert/confirm)
        const showModal = (title, message, icon = 'info') => {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            
            const iconHtml = `<i data-lucide="${icon}" class="lucide-icon text-indigo-600 w-6 h-6 mr-2"></i>`;
            document.getElementById('modal-icon-container').innerHTML =
