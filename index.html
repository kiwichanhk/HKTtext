<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>æ–‡å­—æ¨£æœ¬èˆ‡ä½œå“é›†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@100..900&display=swap');
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        .sample-content {
            white-space: pre-wrap; /* ä¿ç•™æ›è¡Œå’Œç©ºæ ¼ */
        }
        /* Custom modal for alerts/prompts */
        .custom-modal {
            transition: opacity 0.3s ease-in-out;
        }
        .lucide {
            width: 1.25rem;
            height: 1.25rem;
        }
        /* æ¨¡æ…‹æ¡†å‹•ç•« */
        .modal-content-transition {
            transition: transform 0.3s ease-out;
        }
        
        /* è®“ç¯©é¸å™¨å¯ä»¥æ©«å‘æ²å‹•ä¸”éš±è—æ²è»¸ */
        .filter-scroll {
            overflow-x: auto;
            display: flex;
            flex-wrap: nowrap; /* å¼·åˆ¶ä¸æ›è¡Œ */
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
            padding-bottom: 4px; /* é ç•™é™°å½±ç©ºé–“ */
        }
        .filter-scroll::-webkit-scrollbar {
            display: none; /* Chrome, Safari and Opera */
        }

        /* æ‰‹æ©Ÿç‰ˆæ¨™é¡Œä½ˆå±€èª¿æ•´ */
        @media (max-width: 640px) {
            .mobile-compact-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            .mobile-compact-actions {
                width: 100%;
                justify-content: flex-start;
                flex-wrap: wrap;
                gap: 0.5rem;
            }
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, getDocs, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-analytics.js";

        
        // --- 1. è¨­å®šæª”èˆ‡åˆå§‹åŒ– ---
        const firebaseConfig = {
          apiKey: "AIzaSyBnQmqGZQ_94BDgmZFzOJsKDjgYq8ipI2I",
          authDomain: "hkttext.firebaseapp.com",
          projectId: "hkttext",
          storageBucket: "hkttext.firebasestorage.app",
          messagingSenderId: "501339425536",
          appId: "1:501339425536:web:f9ddbf080a002be99701e5",
          measurementId: "G-CKY8VPMJXJ"
        };

        let app, db, auth, analytics, userId = null;
        let originalAuthUid = null; 

        const urlParams = new URLSearchParams(window.location.search);
        const sharedUserId = urlParams.get('userId');

        const getCustomUserId = () => localStorage.getItem('customUserId');
        const setCustomUserId = (customId) => {
            if (customId && customId.trim()) {
                localStorage.setItem('customUserId', customId.trim());
                return true;
            }
            return false;
        };

        const getOriginalAuthUid = () => localStorage.getItem('originalAuthUid');
        const setOriginalAuthUid = (uid) => {
            if (!getOriginalAuthUid()) localStorage.setItem('originalAuthUid', uid);
        };
        
        let samples = [];
        let currentCategoryFilter = 'å…¨éƒ¨';
        let searchTerm = '';
        let activeEditId = null;
        const appId = 'default-app-id';
        
        // ç¢ºä¿ members å§‹çµ‚å¾ localStorage åŠ è¼‰
        let members = JSON.parse(localStorage.getItem('hkt_members')) || ['é€šç”¨']; 
        let currentMemberFilter = 'å…¨éƒ¨'; 

        // åˆå§‹åŒ– Firebase
        try {
            app = initializeApp(firebaseConfig);
            analytics = getAnalytics(app);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (error) {
            console.error("Firebase init error:", error);
            showModal('Firebase åˆå§‹åŒ–å¤±æ•—', error.message, 'alert-octagon');
        }

        
        // --- 2. æ ¸å¿ƒåŠŸèƒ½: å½ˆçª—çµ±ä¸€ ---

        const hideModal = () => {
            const modal = document.getElementById('custom-modal');
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0', 'pointer-events-none');
        };

        const showModal = (title, message, icon = 'info') => {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            
            let iconColor = 'text-indigo-600';
            if (icon === 'alert-triangle' || icon === 'alert-octagon') iconColor = 'text-red-500';
            if (icon === 'check' || icon === 'check-circle') iconColor = 'text-green-500';
            if (icon === 'pin') iconColor = 'text-yellow-600';

            const iconHtml = `<i data-lucide="${icon}" class="lucide-icon ${iconColor} w-6 h-6 mr-2"></i>`;
            document.getElementById('modal-icon-container').innerHTML = iconHtml;
            lucide.createIcons();

            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100');

            setTimeout(() => {
                hideModal();
            }, 5000);
        };
        
        // --- 3. èªè­‰èˆ‡ç›£è½ ---

        const setupSearchListener = () => {
            const input = document.getElementById('search-input');
            if (input) {
                input.addEventListener('input', (e) => {
                    searchTerm = e.target.value;
                    renderUI();
                });
            }
        };

        const signInAndListen = async () => {
            if (!auth) return;
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    originalAuthUid = user.uid;
                    setOriginalAuthUid(user.uid);

                    const customId = getCustomUserId();
                    userId = sharedUserId || customId || user.uid;
                    const isUsingCustomId = getCustomUserId() !== null;
                    const isViewingShared = sharedUserId !== null;
                    const displayId = userId.length > 12 ? userId.substring(0, 8) + '...' : userId;

                    // ç‹€æ…‹åˆ—
                    document.getElementById('auth-status').innerHTML = `
                        <span class="hidden" id="actual-user-id">${userId}</span>
                        ${isViewingShared ? '<span class="text-xs text-orange-600 bg-orange-50 px-2 py-1 rounded mr-1 font-medium whitespace-nowrap">ğŸ‘ï¸ æŸ¥çœ‹</span>' : ''}
                        ${!isViewingShared ? `<button onclick="window.app.setCustomId()" class="text-xs ${isUsingCustomId ? 'text-green-600 bg-green-50 font-semibold' : 'text-gray-600 bg-gray-100'} px-2 py-1 rounded hover:bg-opacity-80 transition mr-1 whitespace-nowrap" title="${isUsingCustomId ? 'é»æ“Šä¿®æ”¹è‡ªè¨‚ID' : 'é»æ“Šè¨­ç½®è‡ªè¨‚ID'}">
                            ğŸ†” ${isUsingCustomId ? displayId : 'ID'}
                        </button>` : ''}
                        <button onclick="window.app.copyShareLink()" class="text-xs text-indigo-600 hover:text-indigo-800 flex items-center bg-indigo-50 px-2 py-1 rounded hover:bg-indigo-100 transition mr-1 whitespace-nowrap" title="è¤‡è£½åˆ†äº«é€£çµ">
                            <i data-lucide="share-2" class="lucide-icon w-3 h-3 mr-1"></i>
                            åˆ†äº«
                        </button>
                        <span class="text-xs text-gray-500 flex items-center bg-gray-50 px-2 py-1 rounded whitespace-nowrap" title="å·²é€£æ¥ Firebase è³‡æ–™åº«">
                            <i data-lucide="database" class="lucide-icon w-3 h-3 mr-1 text-indigo-500"></i>
                            é€£æ¥
                        </span>
                    `;
                    lucide.createIcons();
                    
                    renderUI();
                    setupSearchListener();

                    if (db) {
                        listenForSamples();
                        migrateDataIfNeeded();
                    }
                } else {
                    signInAnonymously(auth).catch((error) => {
                        console.error("Sign in failed:", error);
                        showModal('èªè­‰éŒ¯èª¤', 'ç„¡æ³•ç™»å…¥: ' + error.message, 'alert-octagon');
                    });
                }
            });
        };

        
        // --- 4. Firestore è³‡æ–™æ“ä½œ (åŒ…å«ç½®é ‚èˆ‡æ’åº) ---

        const migrateDataIfNeeded = async () => {
            if (!db || !userId || !originalAuthUid) return;

            const customId = getCustomUserId();
            if (!customId || customId === originalAuthUid) return;

            const customIdPath = collection(db, `artifacts/${appId}/users/${customId}/text_samples`);
            const customIdSnapshot = await getDocs(query(customIdPath));

            if (!customIdSnapshot.empty) return; 

            const originalPath = collection(db, `artifacts/${appId}/users/${originalAuthUid}/text_samples`);
            const originalSnapshot = await getDocs(query(originalPath));

            if (originalSnapshot.empty) return;

            let migratedCount = 0;
            const batch = writeBatch(db);
            for (const doc of originalSnapshot.docs) {
                try {
                    const data = doc.data();
                    delete data.profile; 
                    batch.set(doc(customIdPath, doc.id), data); // ç¢ºä¿ä½¿ç”¨åŸå§‹ doc.id
                    batch.delete(doc(originalPath, doc.id));
                    migratedCount++;
                } catch (e) { console.error(e); }
            }
            if (migratedCount > 0) {
                await batch.commit();
                showModal('æ•¸æ“šå·²é·ç§»', `å·²æˆåŠŸå°‡ ${migratedCount} ç­†æ–‡æœ¬é·ç§»åˆ°æ–°IDã€‚`, 'check-circle');
            }
        };

        const getSamplesCollectionRef = () => {
            if (!userId || !db) return null;
            return collection(db, `artifacts/${appId}/users/${userId}/text_samples`);
        };

        const listenForSamples = () => {
            const colRef = getSamplesCollectionRef();
            if (!colRef) return; 

            const q = query(colRef);
            
            onSnapshot(q, (snapshot) => {
                samples = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // --- æˆå“¡åˆ—è¡¨æ›´æ–°é‚è¼¯å„ªåŒ– ---
                const dbMembers = new Set(samples.map(s => s.member).filter(m => m));
                let membersUpdated = false;
                
                // ç²å–ç•¶å‰ localStorage å­˜å„²çš„æˆå“¡åˆ—è¡¨ï¼ˆæ’é™¤ 'å…¨éƒ¨'/'é€šç”¨'ï¼‰
                let storedMembers = JSON.parse(localStorage.getItem('hkt_members')) || [];
                
                // ç¢ºä¿ 'é€šç”¨' å§‹çµ‚æ˜¯é è¨­é¸é …
                if (!storedMembers.includes('é€šç”¨')) storedMembers.push('é€šç”¨');
                
                // å°‡è³‡æ–™åº«ä¸­çš„æˆå“¡åˆä½µåˆ° storedMembers
                dbMembers.forEach(m => {
                    if (!storedMembers.includes(m)) {
                        storedMembers.push(m);
                        membersUpdated = true;
                    }
                });
                
                // æ›´æ–°å…¨åŸŸ members è®Šæ•¸
                members = storedMembers; 
                
                if (membersUpdated) {
                    // å°‡æ›´æ–°å¾Œçš„åˆ—è¡¨å­˜å› localStorage (æ’é™¤ 'å…¨éƒ¨'ï¼Œé›–ç„¶å®ƒä¸æ‡‰è©²åœ¨åˆ—è¡¨ä¸­)
                    localStorage.setItem('hkt_members', JSON.stringify(members.filter(m => m !== 'å…¨éƒ¨'))); 
                }
                // --- æˆå“¡åˆ—è¡¨æ›´æ–°é‚è¼¯çµæŸ ---
                
                samples.sort((a, b) => {
                    const isPinnedA = a.isPinned || false;
                    const isPinnedB = b.isPinned || false;

                    if (isPinnedA && !isPinnedB) return -1;
                    if (!isPinnedA && isPinnedB) return 1;
                    
                    return (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0);
                });
                
                renderUI(); 
            }, (error) => {
                console.error("Error listening to Firestore:", error);
                showModal('éŒ¯èª¤', 'ç„¡æ³•é€£æ¥åˆ°è³‡æ–™åº«ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šã€‚', 'alert-octagon');
                renderUI(); 
            });
        };
        
        const togglePin = async (id) => {
            const sample = samples.find(s => s.id === id);
            if (!sample) return;
            
            const colRef = getSamplesCollectionRef();
            if (!colRef) return;

            const newPinStatus = !sample.isPinned;
            
            try {
                await updateDoc(doc(colRef, id), {
                    isPinned: newPinStatus
                });
                showModal('ç½®é ‚æˆåŠŸ', `æ¨£æœ¬å·²${newPinStatus ? 'ç½®é ‚' : 'å–æ¶ˆç½®é ‚'}ï¼`, newPinStatus ? 'pin' : 'pin-off');
            } catch (error) {
                showModal('éŒ¯èª¤', `ç½®é ‚æ“ä½œå¤±æ•—: ${error.message}`, 'alert-octagon');
            }
        };

        // ** [ä¿®å¾©] ä½¿ç”¨ MyMemory å…è²» API é€²è¡ŒçœŸå¯¦ç¿»è­¯ **
        const translateToEnglish = async (text) => {
            if (!text || !text.trim()) return '';
            
            try {
                // ä½¿ç”¨ MyMemory API (å…è²»ç‰ˆï¼Œç„¡éœ€ Key)
                const apiUrl = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=zh-TW|en`;
                
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (data && data.responseData && data.responseData.translatedText) {
                    return data.responseData.translatedText;
                } else {
                    console.warn("Translation API warning:", data);
                    return `[ç¿»è­¯æœå‹™å¿™ç¢Œ] è«‹ç¨å¾Œå†è©¦ã€‚åŸå› : ${data.responseDetails || 'æœªçŸ¥éŒ¯èª¤'}`;
                }
            } catch (error) {
                console.error("Translation error:", error);
                return "[ç¿»è­¯å¤±æ•—] ç¶²çµ¡é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯ã€‚";
            }
        };
        
        const saveSample = async (data) => {
            const colRef = getSamplesCollectionRef();
            if (!colRef) {
                showModal('éŒ¯èª¤', 'è³‡æ–™åº«æœå‹™å°šæœªæº–å‚™å¥½ã€‚', 'alert-octagon');
                return;
            }

            try {
                const payload = {
                    title: data.title,
                    content_ch: data.content_ch || '',
                    content_en: data.content_en || '',
                    category: data.category,
                    member: data.member || 'é€šç”¨',
                    timestamp: serverTimestamp()
                };

                if (data.id) {
                    const docRef = doc(colRef, data.id);
                    await updateDoc(docRef, payload);
                    showModal('æˆåŠŸ', 'æ¨£æœ¬å·²æˆåŠŸæ›´æ–°ï¼', 'check-circle');
                } else {
                    await addDoc(colRef, {
                         ...payload,
                         isPinned: false
                    });
                    showModal('æˆåŠŸ', 'æ–°çš„æ–‡å­—æ¨£æœ¬å·²å»ºç«‹ï¼', 'plus-circle');
                }
            } catch (error) {
                console.error("Error saving sample:", error);
                showModal('éŒ¯èª¤', `å„²å­˜å¤±æ•—: ${error.message}`, 'alert-octagon');
            }
        };

        const deleteSample = async (id) => {
            if (!id) return;
            const colRef = getSamplesCollectionRef();
            if (!colRef) return;

            try {
                const docRef = doc(colRef, id);
                await deleteDoc(docRef);
                showModal('åˆªé™¤æˆåŠŸ', 'æ–‡å­—æ¨£æœ¬å·²ç§»é™¤ã€‚', 'trash-2');
            } catch (error) {
                console.error("Error deleting sample:", error);
                showModal('éŒ¯èª¤', `åˆªé™¤å¤±æ•—: ${error.message}`, 'alert-octagon');
            }
        };
        
        // --- 5. UI è¼”åŠ©èˆ‡æ¨¡æ…‹æ¡†é‚è¼¯ ---
        
        const handleDeleteClick = (id) => {
            const modal = document.getElementById('confirm-modal');
            document.getElementById('confirm-message').textContent = 'æ‚¨ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤æ–‡å­—æ¨£æœ¬å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚';
            
            const confirmBtn = document.getElementById('confirm-action-btn');
            confirmBtn.onclick = () => {
                deleteSample(id);
                hideConfirmModal();
            };

            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100');
        };

        const hideConfirmModal = () => {
            const modal = document.getElementById('confirm-modal');
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0', 'pointer-events-none');
        };

        const showAddSampleModal = () => {
            updateNewSampleCategoryOptions();
            updateNewSampleMemberOptions(); 
            const modal = document.getElementById('add-sample-modal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100');
            
            document.getElementById('new-title').value = '';
            document.getElementById('new-content-ch').value = '';
            document.getElementById('new-content-en').value = '';
            document.getElementById('new-category').value = 'æœªåˆ†é¡';
            document.getElementById('new-member').value = 'é€šç”¨'; 
            lucide.createIcons();
        };

        const hideAddSampleModal = () => {
            const modal = document.getElementById('add-sample-modal');
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0', 'pointer-events-none');
        };
        
        const showAddCategoryModal = () => {
            const modal = document.getElementById('add-category-modal');
            document.getElementById('new-category-name').value = '';
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100');
            lucide.createIcons();
        };

        const hideAddCategoryModal = () => {
            const modal = document.getElementById('add-category-modal');
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0', 'pointer-events-none');
        };

        const addNewCategoryAndFilter = async () => {
            const categoryNameInput = document.getElementById('new-category-name');
            const newCategoryName = categoryNameInput.value.trim();

            if (!newCategoryName) {
                showModal('éŒ¯èª¤', 'åˆ†é¡åç¨±ä¸èƒ½ç‚ºç©ºã€‚', 'alert-octagon');
                return;
            }
            
            const existingCategories = getCategories().filter(c => c !== 'å…¨éƒ¨');
            if (existingCategories.includes(newCategoryName)) {
                showModal('æ³¨æ„', `åˆ†é¡ "${newCategoryName}" å·²ç¶“å­˜åœ¨ã€‚`, 'alert-triangle');
                setCategoryFilter(newCategoryName);
                hideAddCategoryModal();
                return;
            }

            const placeholderSample = {
                title: `æ–°åˆ†é¡é ç•™é …ç›®: ${newCategoryName}`,
                content_ch: `é€™æ˜¯ç‚ºæ–°åˆ†é¡ã€Œ${newCategoryName}ã€å»ºç«‹çš„é ç•™æ¨£æœ¬ã€‚è«‹ç·¨è¼¯æˆ–åˆªé™¤æ­¤é …ç›®ã€‚`,
                content_en: '',
                category: newCategoryName,
                member: currentMemberFilter === 'å…¨éƒ¨' ? 'é€šç”¨' : currentMemberFilter 
            };

            try {
                await saveSample(placeholderSample);
                setCategoryFilter(newCategoryName);
                hideAddCategoryModal();
                showModal('åˆ†é¡æ–°å¢æˆåŠŸ', `å·²å»ºç«‹æ–°åˆ†é¡ã€Œ${newCategoryName}ã€ã€‚`, 'folder-check');
            } catch (error) {
                showModal('éŒ¯èª¤', `ç„¡æ³•æ–°å¢åˆ†é¡: ${error.message}`, 'alert-octagon');
            }
        };
        
        const addNewMember = () => {
            const name = prompt("è«‹è¼¸å…¥æ–°æˆå“¡åç¨±ï¼š");
            if (name && name.trim()) {
                const clean = name.trim();
                // æ’é™¤ä¿ç•™åç¨±æˆ–é—œéµå­—
                if (clean === 'å…¨éƒ¨' || clean === 'é€šç”¨') { showModal('ä¿ç•™åç¨±', 'æ­¤åç¨±ä¿ç•™ï¼Œè«‹ä½¿ç”¨å…¶ä»–åç¨±ã€‚', 'alert-triangle'); return; }
                if (!members.includes(clean)) {
                    members.push(clean);
                    localStorage.setItem('hkt_members', JSON.stringify(members.filter(m => m !== 'å…¨éƒ¨')));
                    currentMemberFilter = clean; 
                    renderUI();
                    showModal('æˆåŠŸ', `å·²æ–°å¢æˆå“¡ã€Œ${clean}ã€`);
                } else {
                    showModal('æ³¨æ„', 'æˆå“¡å·²å­˜åœ¨', 'alert-triangle');
                }
            }
        };


        const toggleEditMode = async (id) => {
            const sampleCard = document.getElementById(`sample-${id}`);
            if (!sampleCard) return;

            const isCurrentlyEditing = activeEditId === id;

            if (isCurrentlyEditing) {
                const titleInput = sampleCard.querySelector('#edit-title');
                const contentChInput = sampleCard.querySelector('#edit-content-ch');
                const contentEnInput = sampleCard.querySelector('#edit-content-en');
                const categorySelect = sampleCard.querySelector('#edit-category');
                const memberSelect = sampleCard.querySelector('#edit-member');

                let finalContentEn = contentEnInput.value;
                
                // è‡ªå‹•ç¿»è­¯é‚è¼¯ (ç·¨è¼¯æ™‚)
                if (contentChInput.value.trim() && !finalContentEn.trim()) {
                    showModal('AI ç¿»è­¯å•Ÿå‹•', 'åµæ¸¬åˆ°ä¸­æ–‡å…§å®¹ï¼Œæ­£åœ¨è‡ªå‹•ç”Ÿæˆè‹±æ–‡è­¯æ–‡...', 'globe');
                    finalContentEn = await translateToEnglish(contentChInput.value);
                }
                
                const updatedSample = {
                    id: id,
                    title: titleInput.value,
                    content_ch: contentChInput.value,
                    content_en: finalContentEn,
                    category: categorySelect.value,
                    member: memberSelect.value
                };
                
                saveSample(updatedSample);
                activeEditId = null;

            } else {
                if (activeEditId) {
                    // å¦‚æœæœ‰å…¶ä»–æ¨£æœ¬æ­£åœ¨ç·¨è¼¯ï¼Œå…ˆå–æ¶ˆç·¨è¼¯æ¨¡å¼
                    activeEditId = null;
                    renderUI(); 
                }
                activeEditId = id;
            }
            renderUI();
        };

        const setCategoryFilter = (category) => {
            currentCategoryFilter = category;
            renderUI();
        };
        
        const setMemberFilter = (member) => {
            currentMemberFilter = member;
            renderUI();
        }

        const getCategories = () => {
            // ç²å–æ‰€æœ‰æœ‰æ•ˆçš„åˆ†é¡ï¼ˆæ’é™¤ç©ºå€¼ï¼‰
            const categorySet = new Set(samples.map(s => s.category).filter(c => c));
            let categories = [...Array.from(categorySet).sort()];
            
            // ç¢ºä¿ 'æœªåˆ†é¡' å§‹çµ‚å­˜åœ¨ä¸”æ’åœ¨å‰é¢ï¼Œå¦‚æœå®ƒåœ¨æ¨£æœ¬ä¸­è¢«ä½¿ç”¨
            if (categorySet.has('æœªåˆ†é¡')) {
                categories = categories.filter(c => c !== 'æœªåˆ†é¡');
                categories.unshift('æœªåˆ†é¡');
            } else if (samples.length > 0 && !categorySet.has('æœªåˆ†é¡')) {
                // å¦‚æœæœ‰æ¨£æœ¬ä½†æ²’æœ‰æœªåˆ†é¡ï¼Œä¹Ÿæ‡‰è©²åŒ…å«ä¸€å€‹é è¨­çš„
                categories.unshift('æœªåˆ†é¡');
            }

            // æ‡‰ç”¨è‡ªè¨‚æ’åº (åªé‡å°éä¿ç•™åˆ†é¡)
            const nonReservedCategories = categories.filter(c => c !== 'å…¨éƒ¨' && c !== 'æœªåˆ†é¡');
            const customOrder = JSON.parse(localStorage.getItem('hkt_category_order') || '[]');
            
            let orderedCategories = [];
            
            // è™•ç†è‡ªè¨‚æ’åº
            if (customOrder.length > 0) {
                orderedCategories = customOrder.filter(c => nonReservedCategories.includes(c));
                const unordered = nonReservedCategories.filter(c => !customOrder.includes(c));
                orderedCategories = [...orderedCategories, ...unordered];
            } else {
                orderedCategories = nonReservedCategories;
            }
            
            // é‡çµ„æœ€çµ‚åˆ—è¡¨ï¼š[æœªåˆ†é¡ (å¦‚æœå­˜åœ¨), è‡ªè¨‚æ’åº/å…¶ä»–åˆ†é¡, å…¨éƒ¨]
            const finalCategories = categories.includes('æœªåˆ†é¡') ? ['æœªåˆ†é¡', ...orderedCategories] : orderedCategories;
            finalCategories.push('å…¨éƒ¨');
            
            return finalCategories.filter((value, index, self) => self.indexOf(value) === index); // æ’é™¤é‡è¤‡
        };
        
        // ä¿®æ­£ï¼šç§»å‹•æ™‚æ’é™¤ 'æœªåˆ†é¡' å’Œ 'å…¨éƒ¨'
        const moveCategoryLeft = (cat) => {
            const categories = getCategories().filter(c => c !== 'å…¨éƒ¨' && c !== 'æœªåˆ†é¡'); 
            const idx = categories.indexOf(cat);
            if (idx > 0) {
                [categories[idx], categories[idx-1]] = [categories[idx-1], categories[idx]];
                localStorage.setItem('hkt_category_order', JSON.stringify(categories));
                renderUI();
            }
        };

        const moveCategoryRight = (cat) => {
            const categories = getCategories().filter(c => c !== 'å…¨éƒ¨' && c !== 'æœªåˆ†é¡'); 
            const idx = categories.indexOf(cat);
            if (idx < categories.length - 1 && idx !== -1) {
                [categories[idx], categories[idx+1]] = [categories[idx+1], categories[idx]];
                localStorage.setItem('hkt_category_order', JSON.stringify(categories));
                renderUI();
            }
        };

        const updateNewSampleCategoryOptions = () => {
            const categories = getCategories();
            const categorySelect = document.getElementById('new-category');
            if (!categorySelect) return;
            
            // å‰µå»ºé¸é …ï¼Œæ’é™¤ 'å…¨éƒ¨'ï¼Œè®“ 'æœªåˆ†é¡' æˆç‚ºé è¨­å€¼
            const categoryOptions = categories.filter(c => c !== 'å…¨éƒ¨' && c !== 'æœªåˆ†é¡').map(cat => 
                `<option value="${cat}">${cat}</option>`
            ).join('');

            categorySelect.innerHTML = `
                <option value="æœªåˆ†é¡">æœªåˆ†é¡</option>
                ${categoryOptions}
            `;
        };
        
        const updateNewSampleMemberOptions = () => {
            const memberSelect = document.getElementById('new-member');
            if (!memberSelect) return;
            
            // å‰µå»ºé¸é …ï¼Œæ’é™¤ 'å…¨éƒ¨'
            const memberOptions = members.filter(m => m !== 'å…¨éƒ¨').map(m => 
                `<option value="${m}">${m}</option>`
            ).join('');
            
            memberSelect.innerHTML = memberOptions;
        };
        
        // --- 6. æ¸²æŸ“èˆ‡è¤‡è£½ ---
        const renderSampleCard = (sample) => {
            const date = sample.timestamp ? new Date(sample.timestamp.seconds * 1000).toLocaleString('zh-TW', {
                year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit'
            }) : 'å°šæœªå„²å­˜';

            const categories = getCategories();
            
            // ç¢ºä¿ç·¨è¼¯æ™‚çš„æˆå“¡ä¸‹æ‹‰é¸å–®é¸é …
            const memberOptions = members.filter(m => m !== 'å…¨éƒ¨').map(m => 
                `<option value="${m}" ${sample.member === m ? 'selected' : ''}>${m}</option>`
            ).join('');
            
            // ç¢ºä¿ç·¨è¼¯æ™‚çš„åˆ†é¡ä¸‹æ‹‰é¸å–®é¸é … (æ’é™¤ 'å…¨éƒ¨')
            const allValidCategories = categories.filter(c => c !== 'å…¨éƒ¨');
            
            const categoryOptions = allValidCategories.map(cat => 
                `<option value="${cat}" ${sample.category === cat ? 'selected' : ''}>${cat}</option>`
            ).join('');
            
            const editCategorySelect = `
                <select id="edit-category" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                    ${categoryOptions}
                </select>
            `;
            
            const editMemberSelect = `
                <select id="edit-member" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                    ${memberOptions}
                </select>
            `;

            const isEditing = activeEditId === sample.id;
            const displayContent = (sample.content_ch || "").trim().replace(/\n/g, '<br>');
            const isPinned = sample.isPinned || false;

            return `
                <div id="sample-${sample.id}" class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition duration-300 flex flex-col h-full border-t-4 ${isPinned ? 'border-yellow-500 ring-4 ring-yellow-100' : 'border-indigo-500'}">
                    <div class="flex justify-between items-start mb-4">
                        ${isEditing ? `
                            <input id="edit-title" value="${sample.title}" class="text-xl font-bold text-gray-800 w-full border-b border-gray-300 p-1 mb-2 focus:outline-none focus:border-indigo-500">
                        ` : `
                            <h3 class="text-xl font-bold text-gray-800">${sample.title}</h3>
                        `}
                        <div class="flex-shrink-0 ml-4 flex space-x-2">
                             <button onclick="window.app.togglePin('${sample.id}')" class="${isPinned ? 'text-yellow-600 bg-yellow-100 hover:bg-yellow-200' : 'text-gray-400 bg-gray-100 hover:bg-gray-200'} p-2 rounded-full shadow-md transition duration-150" title="${isPinned ? 'å–æ¶ˆç½®é ‚' : 'ç½®é ‚'}">
                                <i data-lucide="pin" class="lucide-icon w-4 h-4 ${isPinned ? 'fill-yellow-600' : ''}"></i>
                            </button>
                            
                            ${!isEditing ? `
                            <button onclick="window.app.copyText('${sample.id}', 'ch')" class="text-white bg-blue-400 hover:bg-blue-500 p-2 rounded-full shadow-md transition duration-150" title="è¤‡è£½ä¸­æ–‡">
                                <i data-lucide="copy" class="lucide-icon w-4 h-4"></i>
                            </button>
                            <button onclick="window.app.copyText('${sample.id}', 'en')" class="text-white bg-green-400 hover:bg-green-500 p-2 rounded-full shadow-md transition duration-150" title="è¤‡è£½è‹±æ–‡">
                                <i data-lucide="languages" class="lucide-icon w-4 h-4"></i>
                            </button>
                            ` : ''}
                            
                            <button onclick="window.app.toggleEditMode('${sample.id}')" class="text-white ${isEditing ? 'bg-green-500 hover:bg-green-600' : 'bg-indigo-500 hover:bg-indigo-600'} p-2 rounded-full shadow-md transition duration-150">
                                <i data-lucide="${isEditing ? 'save' : 'edit'}" class="lucide-icon w-4 h-4"></i>
                            </button>
                            ${isEditing ? '' : `
                                <button onclick="window.app.handleDeleteClick('${sample.id}')" class="text-white bg-red-500 hover:bg-red-600 p-2 rounded-full shadow-md transition duration-150">
                                    <i data-lucide="trash-2" class="lucide-icon w-4 h-4"></i>
                                </button>
                            `}
                        </div>
                    </div>

                    <div class="mb-4 flex flex-wrap gap-2 items-center">
                        <span class="text-sm font-medium text-purple-600 flex items-center">
                            <i data-lucide="user" class="lucide-icon w-4 h-4 mr-1"></i>
                            ${isEditing ? editMemberSelect : `
                                <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-semibold">${sample.member || 'é€šç”¨'}</span>
                            `}
                        </span>
                        <span class="text-sm font-medium text-indigo-600 flex items-center">
                            <i data-lucide="tag" class="lucide-icon w-4 h-4 mr-1"></i>
                            ${isEditing ? editCategorySelect : `
                                <span class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-semibold">${sample.category || 'æœªåˆ†é¡'}</span>
                            `}
                        </span>
                    </div>
                    
                    ${isEditing ? `
                        
                        <div class="flex flex-col space-y-2 h-96">
                            <label class="text-xs font-bold text-gray-500">ä¸­æ–‡å…§å®¹</label>
                            <textarea id="edit-content-ch" class="flex-grow w-full border border-gray-300 p-2 rounded-lg resize-none focus:ring-indigo-500">${sample.content_ch || ''}</textarea>
                            <label class="text-xs font-bold text-gray-500">è‹±æ–‡å…§å®¹ (è‡ªå‹•ç¿»è­¯)</label>
                            <textarea id="edit-content-en" class="flex-grow w-full border border-gray-300 p-2 rounded-lg resize-none focus:ring-indigo-500">${sample.content_en || ''}</textarea>
                        </div>

                    ` : `
                        <div class="flex-grow text-gray-700 sample-content overflow-auto mb-4 border p-3 rounded-lg bg-gray-50 max-h-64">
                            ${displayContent}
                        </div>
                    `}

                    <p class="text-xs text-gray-500 mt-auto pt-2 border-t border-gray-100 flex justify-between items-center">
                         <span>æœ€å¾Œç·¨è¼¯æ–¼: ${date}</span>
                         ${isPinned ? '<span class="px-2 py-0.5 bg-yellow-400 text-xs font-semibold rounded-full text-gray-800 flex items-center"><i data-lucide="pin" class="lucide-icon w-3 h-3 mr-1"></i>ç½®é ‚ä¸­</span>' : ''}
                    </p>
                </div>
            `;
        };
        
        const createNewSample = async () => {
            const titleInput = document.getElementById('new-title');
            const contentChInput = document.getElementById('new-content-ch');
            const contentEnInput = document.getElementById('new-content-en');
            const categorySelect = document.getElementById('new-category');
            const memberSelect = document.getElementById('new-member'); 
            
            let category = categorySelect.value;
            
            const newSample = {
                title: titleInput.value || 'ç„¡æ¨™é¡Œæ¨£æœ¬',
                content_ch: contentChInput.value || '',
                content_en: contentEnInput.value || '',
                category: category,
                member: memberSelect.value 
            };

            if (!newSample.content_ch.trim() && !newSample.content_en.trim()) {
                showModal('æ³¨æ„', 'ä¸­æ–‡å’Œè‹±æ–‡å…§å®¹ä¸èƒ½åŒæ™‚ç‚ºç©ºï¼', 'alert-triangle');
                return;
            }
            
            // è‡ªå‹•ç¿»è­¯ï¼Œå¦‚æœä¸­æ–‡å…§å®¹å­˜åœ¨ä¸”è‹±æ–‡å…§å®¹ç‚ºç©º
            if (newSample.content_ch.trim() && !newSample.content_en.trim()) {
                showModal('AI ç¿»è­¯å•Ÿå‹•', 'åµæ¸¬åˆ°ä¸­æ–‡å…§å®¹ï¼Œæ­£åœ¨è‡ªå‹•ç”Ÿæˆè‹±æ–‡è­¯æ–‡...', 'globe');
                newSample.content_en = await translateToEnglish(newSample.content_ch);
            }

            saveSample(newSample).then(() => {
                titleInput.value = '';
                contentChInput.value = '';
                contentEnInput.value = '';
                categorySelect.value = 'æœªåˆ†é¡';
                memberSelect.value = 'é€šç”¨';
                hideAddSampleModal();
            });
        };
        
        // --- [æ–°å¢] ç¨ç«‹çš„ç¯©é¸å™¨æ¸²æŸ“å‡½æ•¸ä»¥æé«˜ç©©å®šæ€§ ---
        const renderFilters = () => {
            const filterContainer = document.getElementById('filter-container');
            if (!filterContainer) return;
            
            const createFilterBtn = (text, isActive, onClick, isAdd = false) => `
                <button 
                    onclick="${onClick}"
                    class="px-3 py-1.5 text-sm font-semibold rounded-lg transition duration-150 whitespace-nowrap flex items-center flex-shrink-0
                    ${isAdd 
                        ? 'bg-indigo-50 border border-indigo-300 text-indigo-700 hover:bg-indigo-200 shadow-sm' 
                        : (isActive ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-gray-700 border border-gray-200 hover:bg-indigo-50 shadow-sm')}"
                >
                    ${isAdd ? '<i data-lucide="plus" class="w-3 h-3 mr-1"></i>' : ''}
                    ${text}
                </button>
            `;
            
            const categories = getCategories();
            
            filterContainer.innerHTML = `
                <div class="flex flex-col gap-1 pb-2 border-b border-gray-100">
                    <span class="text-xs font-bold text-gray-500 mr-2 uppercase tracking-wider flex-shrink-0 whitespace-nowrap">æˆå“¡ç¯©é¸</span>
                    <div class="filter-scroll w-full gap-2">
                        ${createFilterBtn('å…¨éƒ¨', currentMemberFilter === 'å…¨éƒ¨', "window.app.setMemberFilter('å…¨éƒ¨')")}
                        ${members.filter(m => m !== 'å…¨éƒ¨').map(m => createFilterBtn(m, currentMemberFilter === m, `window.app.setMemberFilter('${m}')`)).join('')}
                        ${createFilterBtn('æ–°å¢æˆå“¡', false, "window.app.addNewMember()", true)}
                    </div>
                </div>

                <div class="flex flex-col gap-1 pt-1">
                    <span class="text-xs font-bold text-gray-500 mr-2 uppercase tracking-wider flex-shrink-0 whitespace-nowrap">åˆ†é¡ç¯©é¸</span>
                    <div class="filter-scroll w-full gap-2 pb-1">
                        ${categories.map((cat, idx) => {
                            const isAll = cat === 'å…¨éƒ¨';
                            const isUncategorized = cat === 'æœªåˆ†é¡';
                            const buttonClass = currentCategoryFilter === cat ? 'bg-indigo-600 text-white' : 'text-gray-700 hover:bg-indigo-100';
                            
                            // ç§»å‹•ç®­é ­åªå°éä¿ç•™åˆ†é¡é¡¯ç¤º
                            const canMove = !isAll && !isUncategorized;
                            
                            return `
                                <div class="inline-flex items-center bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow flex-shrink-0 whitespace-nowrap">
                                    ${canMove && idx > 0 ? `
                                    <button onclick="window.app.moveCategoryLeft('${cat}')" class="hidden sm:block pl-2 pr-1 py-1.5 hover:bg-gray-100 transition rounded-l-lg text-gray-400 hover:text-gray-600 border-r border-gray-100" title="å‘å·¦ç§»å‹•">
                                        <i data-lucide="chevron-left" class="lucide-icon w-3 h-3"></i>
                                    </button>` : ''}
                                    
                                    <button 
                                        onclick="window.app.setCategoryFilter('${cat}')"
                                        class="px-3 py-1.5 text-sm font-medium transition duration-150 ${buttonClass} ${canMove ? 'rounded-lg sm:rounded-none' : 'rounded-lg'}"
                                    >
                                        ${cat} <span class="text-xs opacity-70 ml-1">(${cat === 'å…¨éƒ¨' ? samples.length : samples.filter(s => s.category === cat).length})</span>
                                    </button>
                                    
                                    ${canMove && idx < categories.length - 1 ? `
                                    <button onclick="window.app.moveCategoryRight('${cat}')" class="hidden sm:block pr-2 pl-1 py-1.5 hover:bg-gray-100 transition rounded-r-lg text-gray-400 hover:text-gray-600 border-l border-gray-100" title="å‘å³ç§»å‹•">
                                        <i data-lucide="chevron-right" class="lucide-icon w-3 h-3"></i>
                                    </button>` : ''}
                                </div>
                            `;
                        }).join('')}
                        
                        <button 
                            onclick="window.app.showAddCategoryModal()"
                            class="px-3 py-1.5 text-sm font-semibold rounded-lg transition duration-150 bg-indigo-50 border border-indigo-300 text-indigo-700 hover:bg-indigo-200 hover:shadow-md flex items-center shadow-sm whitespace-nowrap flex-shrink-0"
                        >
                            <i data-lucide="plus" class="lucide-icon w-3 h-3 mr-1"></i>
                            æ–°å¢
                        </button>
                    </div>
                </div>
            `;
            lucide.createIcons();
        };

        const renderUI = () => {
            const samplesContainer = document.getElementById('samples-container');
            
            if (!samplesContainer) return;
            
            // --- æ¸²æŸ“ç¯©é¸å™¨å€åŸŸ (å‘¼å«ç¨ç«‹å‡½æ•¸) ---
            renderFilters();
            
            // --- ç¯©é¸é‚è¼¯ ---
            let filteredSamples = samples;
            if (currentMemberFilter !== 'å…¨éƒ¨') {
                filteredSamples = filteredSamples.filter(s => s.member === currentMemberFilter);
            }
            if (currentCategoryFilter !== 'å…¨éƒ¨') {
                filteredSamples = filteredSamples.filter(s => s.category === currentCategoryFilter);
            }

            const lowerTerm = searchTerm ? searchTerm.toLowerCase().trim() : '';
            if (lowerTerm) {
                filteredSamples = filteredSamples.filter(s => 
                    (s.title && s.title.toLowerCase().includes(lowerTerm)) || 
                    (s.content_ch && s.content_ch.toLowerCase().includes(lowerTerm)) || 
                    (s.content_en && s.content_en.toLowerCase().includes(lowerTerm))
                );
            }

            if (filteredSamples.length === 0) {
                 if (samples.length === 0 && userId) {
                     samplesContainer.innerHTML = `
                        <div class="col-span-full text-center py-10 bg-white rounded-xl shadow-inner text-gray-500">
                            <i data-lucide="book-open" class="lucide-icon w-12 h-12 mx-auto mb-4 text-gray-300"></i>
                            <p class="text-lg">ç›®å‰æ²’æœ‰ä»»ä½•æ–‡å­—æ¨£æœ¬ã€‚</p>
                            <p class="text-sm">é»æ“Šå³ä¸Šè§’çš„ã€Œæ–°å¢æ–‡å­—æ¨£æœ¬ã€æŒ‰éˆ•é–‹å§‹å‰µå»ºå§ï¼</p>
                        </div>
                    `;
                } else if (!userId) {
                    samplesContainer.innerHTML = `
                        <div class="col-span-full text-center py-10 text-gray-400">
                            <i data-lucide="loader" class="lucide-icon w-8 h-8 mx-auto mb-2 animate-spin"></i>
                            <p>æ­£åœ¨è¼‰å…¥æ‚¨çš„ä½œå“...</p>
                        </div>
                    `;
                } else {
                     samplesContainer.innerHTML = `
                        <div class="col-span-full text-center py-10 bg-white rounded-xl shadow-inner text-gray-500">
                            <i data-lucide="folder-open" class="lucide-icon w-12 h-12 mx-auto mb-4 text-gray-300"></i>
                            <p class="text-lg">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æ¨£æœ¬ã€‚</p>
                            <p class="text-sm">ç¯©é¸æ¢ä»¶: æˆå“¡ ${currentMemberFilter} | åˆ†é¡ ${currentCategoryFilter}</p>
                            <button onclick="window.app.setMemberFilter('å…¨éƒ¨'); window.app.setCategoryFilter('å…¨éƒ¨');" class="mt-2 text-indigo-600 hover:underline">
                                æ¸…é™¤æ‰€æœ‰ç¯©é¸
                            </button>
                        </div>
                    `;
                }
            } else {
                samplesContainer.innerHTML = filteredSamples.map(renderSampleCard).join('');
            }
            
            lucide.createIcons();
        };

        // --- 7. æš´éœ²çµ¦ Window ---
        window.app = {
            moveCategoryLeft,
            moveCategoryRight,
            togglePin,
            copyText: (id, lang) => {
                const sample = samples.find(s => s.id === id);
                if(!sample) return;
                const text = lang === 'ch' ? sample.content_ch : sample.content_en;
                
                if(!text || !text.trim()) {
                    showModal('å…§å®¹ç‚ºç©º', 'è©²èªè¨€å…§å®¹ç‚ºç©ºï¼Œè«‹å…ˆç·¨è¼¯ï¼', 'alert-triangle');
                    return;
                }
                
                navigator.clipboard.writeText(text).then(() => {
                    showModal('è¤‡è£½æˆåŠŸ', (lang==='ch'?'ä¸­æ–‡':'è‹±æ–‡') + 'å…§å®¹å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'check');
                    setTimeout(() => window.app.hideModal(), 1500);
                });
            },

            setCategoryFilter,
            setMemberFilter, 
            addNewMember,
            toggleEditMode,
            createNewSample,
            handleDeleteClick,
            hideConfirmModal,
            setCustomId: async () => {
                const currentCustomId = getCustomUserId();
                const currentMessage = currentCustomId 
                    ? `ç•¶å‰è‡ªè¨‚IDï¼š${currentCustomId}\n\nè¼¸å…¥æ–°IDä¾†æ›´æ”¹ï¼Œæˆ–ç•™ç©ºå–æ¶ˆï¼š` 
                    : 'è¨­ç½®ä¸€å€‹ç°¡çŸ­çš„è‡ªè¨‚IDï¼ˆä¾‹å¦‚ï¼škiwi123ï¼‰\n\né€™æ¨£åˆ†äº«é€£çµæœƒæ›´çŸ­æ›´å¥½è¨˜ï¼\n\nâš ï¸ è¨­ç½®å¾Œæœƒè‡ªå‹•é·ç§»æ‚¨çš„æ‰€æœ‰æ–‡æœ¬ã€‚';

                const newId = prompt(currentMessage, currentCustomId || '');

                if (newId === null) return;

                if (newId.trim() === '') {
                    if (currentCustomId) {
                        showModal('æç¤º', 'å¦‚éœ€åˆªé™¤è‡ªè¨‚IDï¼Œè«‹ç›´æ¥ä½¿ç”¨åŸå§‹IDåˆ†äº«é€£çµã€‚', 'info');
                    }
                    return;
                }

                if (!/^[a-zA-Z0-9_]{3,20}$/.test(newId.trim())) {
                    showModal('æ ¼å¼éŒ¯èª¤', 'IDåªèƒ½åŒ…å«è‹±æ–‡ã€æ•¸å­—å’Œåº•ç·šï¼Œé•·åº¦3-20å­—ç¬¦ã€‚', 'alert-octagon');
                    return;
                }

                if (setCustomUserId(newId)) {
                    showModal('è¨­ç½®æˆåŠŸ', `è‡ªè¨‚IDå·²è¨­ç½®ç‚ºï¼š${newId}\n\næ­£åœ¨é‡æ–°è¼‰å…¥é é¢ä¸¦é·ç§»æ•¸æ“š...`, 'check-circle');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                }
            },

            copyShareLink: () => {
                const currentUserId = sharedUserId || userId;
                const shareUrl = `${window.location.origin}${window.location.pathname}?userId=${currentUserId}`;

                navigator.clipboard.writeText(shareUrl).then(() => {
                    showModal('åˆ†äº«é€£çµå·²è¤‡è£½ ğŸ“‹', `æ‚¨å¯ä»¥å°‡æ­¤é€£çµåˆ†äº«çµ¦å…¶ä»–è¨­å‚™ï¼š\n\n${shareUrl}`, 'share-2');
                }).catch(err => {
                    showModal('åˆ†äº«é€£çµ', `è«‹è¤‡è£½ä»¥ä¸‹é€£çµï¼š\n\n${shareUrl}`, 'share-2');
                });
            },

            showAddSampleModal,
            hideAddSampleModal,
            showAddCategoryModal,
            hideAddCategoryModal,
            addNewCategoryAndFilter,
            hideModal, 
            saveSample,
            renderUI,
        };
        
        window.onload = () => {
            if (auth && db) {
                signInAndListen();
            } else {
                console.warn("Firebase æœªæˆåŠŸåˆå§‹åŒ–ï¼Œè·³éèªè­‰æµç¨‹ã€‚");
            }
        };

    </script>
</head>
<body class="bg-gray-50 min-h-screen">

    
    <div id="custom-modal" class="custom-modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-95" onclick="event.stopPropagation()">
            <div class="flex items-center mb-4">
                <span id="modal-icon-container" class="flex items-center justify-center"></span>
                <h3 id="modal-title" class="text-lg font-bold text-gray-800">è¨Šæ¯</h3>
                <button onclick="window.app.hideModal()" class="ml-auto text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="lucide-icon w-5 h-5"></i>
                </button>
            </div>
            <p id="modal-message" class="text-gray-600 mb-4"></p>
            <div class="flex justify-end">
                <button onclick="window.app.hideModal()" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition duration-150">ç¢ºå®š</button>
            </div>
        </div>
    </div>
    
    <div id="confirm-modal" class="custom-modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-95" onclick="event.stopPropagation()">
            <div class="flex items-center mb-4">
                <i data-lucide="alert-triangle" class="lucide-icon text-red-500 w-6 h-6 mr-2"></i>
                <h3 class="text-lg font-bold text-gray-800">ç¢ºèªæ“ä½œ</h3>
            </div>
            <p id="confirm-message" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button onclick="window.app.hideConfirmModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150">å–æ¶ˆ</button>
                <button id="confirm-action-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150">ç¢ºèªåˆªé™¤</button>
            </div>
        </div>
    </div>
    
    <div id="add-sample-modal" class="custom-modal fixed inset-0 z-40 flex items-center justify-center bg-black bg-opacity-70 opacity-0 pointer-events-none" onclick="window.app.hideAddSampleModal()">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-xl lg:max-w-4xl w-full max-h-[90vh] overflow-y-auto transform transition-all duration-300 modal-content-transition scale-90" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h2 class="text-2xl font-extrabold text-indigo-800 flex items-center">
                    <i data-lucide="pen-tool" class="lucide-icon w-6 h-6 mr-2"></i>
                    æ–°å¢æ–‡å­—æ¨£æœ¬
                </h2>
                <button onclick="window.app.hideAddSampleModal()" class="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100">
                    <i data-lucide="x" class="lucide-icon w-6 h-6"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                 <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æˆå“¡æ­¸å±¬</label>
                    <select id="new-member" class="w-full border border-gray-300 p-3 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm bg-white">
                        </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">åˆ†é¡</label>
                    <select id="new-category" class="w-full border border-gray-300 p-3 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm bg-white">
                        </select>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">æ¨™é¡Œ</label>
                <input type="text" id="new-title" class="w-full border border-gray-300 p-3 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm" placeholder="ç‚ºé€™å€‹ä½œå“å–å€‹åå­—...">
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ä¸­æ–‡å…§å®¹ (Chinese)</label>
                    <textarea id="new-content-ch" class="w-full h-64 border border-gray-300 p-3 rounded-lg resize-none focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm" placeholder="åœ¨é€™è£¡è¼¸å…¥æˆ–è²¼ä¸Šæ‚¨çš„æ–‡å­—å…§å®¹..."></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">è‹±æ–‡å…§å®¹ (English) <span class="text-xs text-indigo-500 font-normal">(ç•™ç©ºå°‡è‡ªå‹• AI ç¿»è­¯)</span></label>
                    <textarea id="new-content-en" class="w-full h-64 border border-gray-300 p-3 rounded-lg resize-none focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm" placeholder="Enter or paste your English text here..."></textarea>
                </div>
            </div>

            <div class="flex justify-end mt-6 pt-4 border-t border-gray-100 space-x-3">
                <button onclick="window.app.hideAddSampleModal()" class="px-5 py-2 bg-white border border-gray-300 text-gray-700 rounded-full hover:bg-gray-50 transition duration-150 font-medium">å–æ¶ˆ</button>
                <button onclick="window.app.createNewSample()" class="px-6 py-2 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition duration-150 shadow-md flex items-center font-medium">
                    <i data-lucide="save" class="lucide-icon w-4 h-4 mr-2"></i>
                    å„²å­˜æ¨£æœ¬
                </button>
            </div>
        </div>
    </div>
    
    <div id="add-category-modal" class="custom-modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all duration-300 scale-95" onclick="event.stopPropagation()">
             <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">æ–°å¢åˆ†é¡</h3>
                <button onclick="window.app.hideAddCategoryModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="lucide-icon w-5 h-5"></i>
                </button>
            </div>
            <p class="text-sm text-gray-600 mb-4">è«‹è¼¸å…¥æ–°åˆ†é¡çš„åç¨±ï¼š</p>
            <input type="text" id="new-category-name" class="w-full border border-gray-300 p-2 rounded-lg mb-4 focus:ring-indigo-500 focus:border-indigo-500" placeholder="ä¾‹å¦‚ï¼šæœƒè­°è¨˜éŒ„">
            <div class="flex justify-end space-x-2">
                <button onclick="window.app.hideAddCategoryModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150">å–æ¶ˆ</button>
                <button onclick="window.app.addNewCategoryAndFilter()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-150">æ–°å¢ä¸¦åˆ‡æ›</button>
            </div>
        </div>
    </div>

    <div id="app-container" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 md:py-8">
        
        <div class="bg-white rounded-2xl shadow-xl p-3 md:p-6 mb-4 border-l-8 border-indigo-600 flex flex-col lg:flex-row justify-between items-center relative overflow-hidden">
             <div class="absolute top-0 right-0 -mt-10 -mr-10 w-40 h-40 bg-indigo-50 rounded-full opacity-50 pointer-events-none hidden md:block"></div>
            
            <div class="z-10 w-full">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-2 md:gap-4 mb-2">
                    <div class="flex justify-between items-center">
                        <h1 class="text-xl md:text-4xl font-extrabold text-gray-900 tracking-tight">KIWI QUICK TEXT</h1>
                    </div>

                    <div class="flex flex-wrap items-center justify-start md:justify-end gap-2 mt-1 md:mt-0 mobile-compact-actions">
                        <div id="auth-status" class="flex items-center flex-wrap gap-1 text-sm text-gray-500">
                            <i data-lucide="loader" class="lucide-icon w-4 h-4 animate-spin text-indigo-500"></i>
                            <span>é€£æ¥ä¸­...</span>
                        </div>

                        <button 
                            onclick="window.app.showAddSampleModal()" 
                            class="px-3 py-1.5 md:px-6 md:py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-full shadow-lg hover:shadow-xl transition flex items-center whitespace-nowrap text-sm md:text-base"
                        >
                            <i data-lucide="plus" class="w-4 h-4 md:w-5 md:h-5 mr-1 md:mr-2"></i>
                            <span class="hidden md:inline">æ–°å¢æ–‡å­—æ¨£æœ¬</span>
                            <span class="md:hidden">æ–°å¢</span>
                        </button>
                    </div>
                </div>

                <div class="mb-1">
                    <div class="relative max-w-full">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="search" class="w-5 h-5 text-gray-400"></i>
                        </div>
                        <input 
                            type="text" 
                            id="search-input"
                            class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-xl leading-5 bg-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition shadow-sm text-sm md:text-base"
                            placeholder="æœå°‹æ¨£æœ¬æ¨™é¡Œæˆ–å…§å®¹..."
                        >
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-md p-3 md:p-4 mb-10 sticky top-2 md:top-4 z-30 bg-opacity-95 backdrop-blur-sm border border-gray-100">
            <div id="filter-container" class="flex flex-col gap-2 md:gap-4">
                 <span class="text-gray-400 text-sm italic">è¼‰å…¥ç¯©é¸å™¨ä¸­...</span>
            </div>
        </div>

        <div id="samples-container" class="mt-6 md:mt-10 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-10">
            <div class="col-span-full flex flex-col items-center justify-center py-20 text-gray-400 opacity-70">
                <i data-lucide="loader" class="lucide-icon w-10 h-10 mb-3 animate-spin text-indigo-300"></i>
                <p>æ­£åœ¨è¼‰å…¥æ‚¨çš„ä½œå“...</p>
            </div>
        </div>
    </div>

</body>
</html>
